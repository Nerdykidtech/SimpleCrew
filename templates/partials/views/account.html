<div id="view-account" class="view-section">
    <div class="section-header-row"><span class="tab-title">My Account</span></div>
    <div class="data-container" style="padding: 24px 20px;">
        <div style="max-width: 700px; margin: 0 auto;">

            <!-- Account Information -->
            <div class="settings-category-label">Account</div>

            <!-- Bank Account Details -->
            <div class="settings-section collapsed" id="bank-details-section">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9); color: #2E7D32;">&#x1f3e6;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Bank Account Details</div>
                        <div class="settings-section-subtitle">Account & routing numbers</div>
                    </div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="bank-details-content">
                        <p style="font-size: 13px; color: var(--text-muted); margin: 12px 0;">Tap the eye icon to reveal your account details.</p>
                        <div id="bank-details-loading" style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">Loading account details...</div>
                        <div id="bank-details-data" style="display: none;">
                            <div class="bank-account-card">
                                <div class="bank-account-card-title">
                                    <span style="font-size: 16px;">&#x1f4b3;</span> Crew Account
                                </div>
                                <div class="bank-detail-row">
                                    <span class="bank-detail-label">Main Account #</span>
                                    <div class="bank-detail-value">
                                        <span id="spend-account-num" class="bank-detail-hidden">&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;</span>
                                        <button class="bank-reveal-btn" onclick="toggleBankDetail('spend-account-num', event)">Show</button>
                                    </div>
                                </div>
                                <div class="bank-detail-row">
                                    <span class="bank-detail-label">Main Routing #</span>
                                    <div class="bank-detail-value">
                                        <span id="spend-routing-num" class="bank-detail-hidden">&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;</span>
                                        <button class="bank-reveal-btn" onclick="toggleBankDetail('spend-routing-num', event)">Show</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="bank-details-error" style="display: none; color: #c00; font-size: 13px; padding: 12px; background: #fee; border-radius: 8px; margin-top: 12px;"></div>
                    </div>
                </div>
            </div>

            <!-- API Connections -->
            <div class="settings-category-label">Connections</div>

            <!-- Crew Banking -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #E3F2FD, #BBDEFB); color: #1565C0;">&#x1f3e6;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Crew Banking</div>
                        <div class="settings-section-subtitle">Primary banking connection</div>
                    </div>
                    <div class="settings-section-badge" id="crew-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="crew-config-form" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 13px;">Bearer Token</label>
                            <input type="password" id="crew-token-input" placeholder="Enter Crew bearer token" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">Find this in your Crew account settings under API access.</p>
                        </div>
                        <div id="crew-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveCrewToken()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save Token</button>
                            <button onclick="cancelCrewEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="crew-config-display" style="display: none; margin-top: 16px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editCrewToken()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update Token</button>
                            <button onclick="testCrewConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SimpleFin -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #F3E5F5, #E1BEE7); color: #7B1FA2;">&#x1f510;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">SimpleFin</div>
                        <div class="settings-section-subtitle">Credit card transaction sync</div>
                    </div>
                    <div class="settings-section-badge" id="simplefin-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="simplefin-config-form" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 13px;">Setup Token</label>
                            <input type="password" id="simplefin-token-input" placeholder="Enter SimpleFin setup token" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">Get your setup token from <a href="https://bridge.simplefin.org/simplefin/claim" target="_blank" style="color: var(--simple-blue);">SimpleFin Bridge</a>.</p>
                        </div>
                        <div id="simplefin-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveSimpleFinToken()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save Token</button>
                            <button onclick="cancelSimpleFinEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="simplefin-config-display" style="display: none; margin-top: 16px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editSimpleFinToken()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update Token</button>
                            <button onclick="testSimpleFinConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LunchFlow -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2); color: #E65100;">&#x1f371;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">LunchFlow</div>
                        <div class="settings-section-subtitle">Alternative credit card sync</div>
                    </div>
                    <div class="settings-section-badge" id="lunchflow-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="lunchflow-config-form" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 13px;">API Key</label>
                            <input type="password" id="lunchflow-apikey-input" placeholder="Enter LunchFlow API key" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">Get your API key from <a href="https://lunchflow.app" target="_blank" style="color: var(--simple-blue);">LunchFlow Dashboard</a>.</p>
                        </div>
                        <div id="lunchflow-account-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveLunchFlowKey()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save API Key</button>
                            <button onclick="cancelLunchFlowEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="lunchflow-config-display" style="display: none; margin-top: 16px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editLunchFlowKey()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update API Key</button>
                            <button onclick="testLunchFlowConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Splitwise -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9); color: #2E7D32;">&#x1f4ca;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Splitwise</div>
                        <div class="settings-section-subtitle">Expense sharing integration</div>
                    </div>
                    <div class="settings-section-badge" id="splitwise-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="splitwise-config-form" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 13px;">API Key</label>
                            <input type="password" id="splitwise-apikey-input" placeholder="Enter Splitwise API key" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">Get your API key from <a href="https://secure.splitwise.com/apps" target="_blank" style="color: var(--simple-blue);">Splitwise Apps</a>.</p>
                        </div>
                        <div id="splitwise-account-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveSplitwiseKey()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save API Key</button>
                            <button onclick="cancelSplitwiseEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="splitwise-config-display" style="display: none; margin-top: 16px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editSplitwiseKey()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update API Key</button>
                            <button onclick="testSplitwiseConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="settings-category-label">Notifications</div>

            <!-- Push Notifications -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #FFF8E1, #FFECB3); color: #F57F17;">&#x1f514;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Push Notifications</div>
                        <div class="settings-section-subtitle">Credit card sync alerts</div>
                    </div>
                    <div class="settings-section-badge" id="notification-status"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <p style="font-size: 13px; color: var(--text-dark); margin: 12px 0 16px 0;">
                        Enable push notifications to receive alerts when new transactions are synced from your credit cards.
                    </p>
                    <button onclick="requestNotificationPermission()"
                            style="background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        Enable Notifications
                    </button>
                </div>
            </div>

            <!-- VAPID Configuration -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #E0F7FA, #B2EBF2); color: #00838F;">&#x1f511;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">VAPID Keys</div>
                        <div class="settings-section-subtitle">Web Push authentication</div>
                    </div>
                    <div class="settings-section-badge" id="fcm-config-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div style="background: var(--bg-elevated); border-left: 3px solid var(--simple-blue); padding: 12px 16px; border-radius: 4px; margin: 12px 0 16px 0;">
                        <p style="font-size: 12px; color: var(--text-dark); margin: 0; line-height: 1.6;">
                            <strong>Setup:</strong> Generate keys at <a href="https://vapidkeys.com" target="_blank" style="color: var(--simple-blue);">vapidkeys.com</a>
                            or run <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; font-size: 11px;">npx web-push generate-vapid-keys</code>
                        </p>
                    </div>
                    <div id="fcm-config-form">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">VAPID Public Key</label>
                            <input type="text" id="fcm-vapid-public" placeholder="Enter VAPID public key"
                                   style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">VAPID Private Key</label>
                            <input type="password" id="fcm-vapid-private" placeholder="Enter VAPID private key"
                                   style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div id="fcm-config-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveFcmConfig()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save Configuration</button>
                            <button onclick="testFcmConfig()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Send Test</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security -->
            <div class="settings-category-label">Security</div>

            <!-- Change Password -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #FCE4EC, #F8BBD0); color: #C62828;">&#x1f512;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Password</div>
                        <div class="settings-section-subtitle">Update your account password</div>
                    </div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <form id="changePasswordForm" style="margin-top: 12px;">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">New Password</label>
                            <input type="password" id="newPassword" placeholder="Min. 8 characters" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div id="passwordMessage" style="padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <button type="submit" style="background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update Password</button>
                    </form>
                </div>
            </div>

            <!-- Passkeys -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #EDE7F6, #D1C4E9); color: #4527A0;">&#x1f511;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Passkeys</div>
                        <div class="settings-section-subtitle">Face ID, Touch ID, or security keys</div>
                    </div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div style="display: flex; justify-content: flex-end; margin-top: 12px; margin-bottom: 12px;">
                        <button id="showAddPasskeyBtn" style="background: var(--simple-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">+ Add Passkey</button>
                    </div>
                    <div id="addPasskeyForm" style="display: none; background: var(--bg-elevated); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: var(--text-dark); margin: 0 0 12px 0;">Add New Passkey</h4>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">Nickname</label>
                            <input type="text" id="passkeyNickname" placeholder='e.g., "My iPhone", "Security Key"' style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="addPasskeyBtn" style="background: var(--simple-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; flex: 1;">Create Passkey</button>
                            <button id="cancelAddPasskeyBtn" style="background: transparent; color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="passkeysList">
                        <p style="color: var(--text-light); text-align: center; font-size: 13px;">Loading passkeys...</p>
                    </div>
                </div>
            </div>

            <!-- Passkey Configuration -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #ECEFF1, #CFD8DC); color: #37474F;">&#x2699;&#xFE0F;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Passkey Configuration</div>
                        <div class="settings-section-subtitle">Domain settings for WebAuthn</div>
                    </div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div style="background: var(--bg-elevated); border-radius: 8px; padding: 12px 16px; margin: 12px 0 16px 0;">
                        <p style="font-size: 12px; color: var(--text-light); line-height: 1.5; margin: 0;">
                            <strong style="color: var(--text-dark);">Localhost:</strong> <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; font-size: 11px;">localhost</code> / <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; font-size: 11px;">http://localhost:8080</code><br>
                            <strong style="color: var(--text-dark);">Production:</strong> Your domain and HTTPS URL
                        </p>
                    </div>
                    <form id="webauthnConfigForm">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">
                                Relying Party ID <span style="font-weight: normal; color: var(--text-light); font-size: 12px;">- domain name</span>
                            </label>
                            <input type="text" id="webauthnRpId" placeholder="localhost" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">
                                Origin URL <span style="font-weight: normal; color: var(--text-light); font-size: 12px;">- full app URL</span>
                            </label>
                            <input type="text" id="webauthnOrigin" placeholder="http://localhost:8080" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div id="webauthnConfigMessage" style="padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save Configuration</button>
                            <button type="button" onclick="testWebAuthnConfig()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Automation -->
            <div class="settings-category-label">Automation</div>

            <div class="settings-section collapsed" id="autopilot-rules-section">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2); color: #E65100;">&#x2699;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">AutoPilot Rules</div>
                        <div class="settings-section-subtitle">Round up purchases and save the change</div>
                    </div>
                    <div class="settings-section-badge" id="autopilot-rules-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="autopilot-rules-content">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">Loading rules...</div>
                    </div>
                </div>
            </div>

            <!-- Security Note -->
            <div style="background: var(--bg-elevated); border-radius: 10px; padding: 16px 20px; margin-top: 24px;">
                <p style="font-size: 12px; color: var(--text-light); line-height: 1.6; margin: 0;">
                    <strong style="color: var(--text-dark);">Security Note</strong> &mdash; Your credentials are stored securely in your local database and are never transmitted except when validating against the respective APIs.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Accordion toggle
function toggleSettingsSection(headerEl) {
    const section = headerEl.closest('.settings-section');
    section.classList.toggle('collapsed');
}

// Bank detail reveal/hide
const bankDetailData = {};
function toggleBankDetail(id, event) {
    event.stopPropagation();
    const el = document.getElementById(id);
    const btn = event.target;

    if (el.dataset.revealed === 'true') {
        el.textContent = '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022';
        el.classList.add('bank-detail-hidden');
        el.dataset.revealed = 'false';
        btn.textContent = 'Show';
    } else {
        const val = bankDetailData[id];
        if (val) {
            el.textContent = val;
            el.classList.remove('bank-detail-hidden');
            el.dataset.revealed = 'true';
            btn.textContent = 'Hide';
        }
    }
}

// Fetch bank account details
async function loadBankAccountDetails() {
    const loadingEl = document.getElementById('bank-details-loading');
    const dataEl = document.getElementById('bank-details-data');
    const errorEl = document.getElementById('bank-details-error');

    try {
        const response = await fetch('/api/account/bank-details');
        const data = await response.json();

        if (data.success) {
            bankDetailData['spend-account-num'] = data.spendAccountNumber || 'N/A';
            bankDetailData['spend-routing-num'] = data.spendRoutingNumber || 'N/A';

            loadingEl.style.display = 'none';
            dataEl.style.display = 'block';
        } else {
            loadingEl.style.display = 'none';
            errorEl.textContent = data.error || 'Failed to load bank details';
            errorEl.style.display = 'block';
        }
    } catch (error) {
        loadingEl.style.display = 'none';
        errorEl.textContent = 'Could not load bank details. Ensure Crew Banking is configured.';
        errorEl.style.display = 'block';
    }
}

// Load FCM config status
async function loadFcmConfigStatus() {
    try {
        const response = await fetch('/api/account/fcm/config');
        const data = await response.json();
        const badgeEl = document.getElementById('fcm-config-status-badge');
        if (data.configured) {
            badgeEl.innerHTML = '<span style="background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">Configured</span>';
        } else {
            badgeEl.innerHTML = '<span style="background: #e9ecef; color: #6c757d; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">Not Set</span>';
        }
    } catch (error) {
        console.error('Failed to load FCM config status:', error);
    }
}

async function saveFcmConfig() {
    const errorEl = document.getElementById('fcm-config-error');
    try {
        const config = {
            vapid_public_key: document.getElementById('fcm-vapid-public').value.trim(),
            vapid_private_key: document.getElementById('fcm-vapid-private').value.trim()
        };
        if (!config.vapid_public_key || !config.vapid_private_key) {
            errorEl.textContent = 'Both VAPID keys are required';
            errorEl.style.display = 'block';
            return;
        }
        errorEl.style.display = 'none';
        const response = await fetch('/api/account/fcm/update-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        const data = await response.json();
        if (data.success) {
            appAlert('VAPID configuration saved successfully', 'Success');
            loadFcmConfigStatus();
            document.getElementById('fcm-vapid-private').value = '';
        } else {
            errorEl.textContent = data.error || 'Failed to save configuration';
            errorEl.style.display = 'block';
        }
    } catch (error) {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.style.display = 'block';
    }
}

async function testFcmConfig() {
    try {
        const response = await fetch('/api/account/fcm/test', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            appAlert('Test notification sent! Check your browser.', 'Success');
        } else {
            appAlert('Failed: ' + data.error, 'Error');
        }
    } catch (error) {
        appAlert('Network error', 'Error');
    }
}

// Init on load
if (document.getElementById('fcm-config-status-badge')) {
    loadFcmConfigStatus();
}
if (document.getElementById('bank-details-section')) {
    loadBankAccountDetails();
}
if (document.getElementById('autopilot-rules-section')) {
    loadAutoPilotRules();
}

// AutoPilot Rules
const TRIGGER_LABELS = {
    'DEBIT_CARD_TRANSACTION': 'Card Purchase',
    'CASH_TRANSACTION_OCCURRED': 'Any Transaction',
    'ACCOUNT_BALANCE_UPDATED': 'Balance Change',
    'ACCOUNT_DEPOSIT_RECEIVED': 'Deposit Received',
    'DIRECT_DEPOSIT': 'Direct Deposit',
    'EXTERNAL_TRANSFER': 'External Transfer',
    'SCHEDULED': 'Scheduled'
};
const TRIGGER_ICONS = {
    'DEBIT_CARD_TRANSACTION': '&#x1F4B3;',
    'CASH_TRANSACTION_OCCURRED': '&#x26A1;',
    'ACCOUNT_BALANCE_UPDATED': '&#x1F4CA;',
    'ACCOUNT_DEPOSIT_RECEIVED': '&#x1F4B0;',
    'DIRECT_DEPOSIT': '&#x1F4B0;',
    'EXTERNAL_TRANSFER': '&#x1F3E6;',
    'SCHEDULED': '&#x23F0;'
};
const ACTION_LABELS = {
    'ROUND_UP_TRANSFER': 'Round Up Savings',
    'TARGET_BALANCE_TRANSFER': 'Balance Protection',
    'SPLIT_DEPOSIT': 'Split Deposit (%)',
    'SPLIT_DEPOSIT_BY_AMOUNT': 'Split Deposit ($)',
    'INTERNAL_TRANSFER': 'Auto Transfer',
    'SEND_NOTIFICATION': 'Send Notification',
    'SEND_WEBHOOK': 'Webhook'
};
const ACTION_ICONS = {
    'ROUND_UP_TRANSFER': '&#x1F4B0;',
    'TARGET_BALANCE_TRANSFER': '&#x1F6E1;',
    'SPLIT_DEPOSIT': '&#x2702;',
    'SPLIT_DEPOSIT_BY_AMOUNT': '&#x2702;',
    'INTERNAL_TRANSFER': '&#x1F504;',
    'SEND_NOTIFICATION': '&#x1F514;',
    'SEND_WEBHOOK': '&#x1F517;'
};

function toggleRuleDetail(cardEl) {
    const detail = cardEl.querySelector('.autopilot-rule-detail');
    const chevron = cardEl.querySelector('.autopilot-rule-chevron');
    if (!detail) return;

    const isOpen = detail.style.display !== 'none';
    detail.style.display = isOpen ? 'none' : 'block';
    if (chevron) chevron.style.transform = isOpen ? 'rotate(-90deg)' : 'rotate(0deg)';

}

async function loadRuleCards(ruleId, container) {
    container.innerHTML = '<div style="text-align:center; padding:12px; color:var(--text-muted); font-size:12px;">Loading cards...</div>';
    try {
        const res = await fetch(`/api/account/autopilot-rules/${encodeURIComponent(ruleId)}/details`);
        const data = await res.json();

        if (data.error || !data.cards) {
            container.innerHTML = '<div style="padding:10px; color:var(--text-muted); font-size:12px;">Could not load cards</div>';
            return;
        }

        if (data.cards.length === 0) {
            container.innerHTML = '<div style="padding:10px; color:var(--text-muted); font-size:12px;">No cards linked to this rule</div>';
            return;
        }

        let html = '';
        data.cards.forEach(card => {
            const bg = (typeof cardColors !== 'undefined' && cardColors[card.color]) || '#555';
            const isActive = card.status === 'ACTIVATED' && card.frozenStatus !== 'FROZEN';
            const statusDot = isActive
                ? '<span class="rule-card-dot active"></span>'
                : '<span class="rule-card-dot inactive"></span>';
            const typeLabel = (card.type === 'VIRTUAL' || card.type === 'SINGLE_USE') ? 'Virtual' : 'Physical';
            const statusLabel = card.frozenStatus === 'FROZEN' ? 'Frozen' : (card.status === 'ACTIVATED' ? 'Active' : card.status);

            html += `
            <div class="rule-card-chip">
                <div class="rule-card-mini" style="background: linear-gradient(135deg, ${bg} 0%, ${bg}cc 100%);">
                    <div class="rule-card-mini-chip"></div>
                    <div class="rule-card-mini-num">&bull;&bull;${card.lastFour}</div>
                </div>
                <div class="rule-card-chip-info">
                    <div class="rule-card-chip-name">${card.cardholderName || card.name}</div>
                    <div class="rule-card-chip-meta">${typeLabel} &bull; &bull;&bull;${card.lastFour}</div>
                </div>
                <div class="rule-card-chip-status">${statusDot} ${statusLabel}</div>
            </div>`;
        });
        container.innerHTML = html;
    } catch (err) {
        console.error('Error loading rule cards:', err);
        container.innerHTML = '<div style="padding:10px; color:var(--alert-red); font-size:12px;">Network error</div>';
    }
}

function buildActionDetail(action) {
    const type = action.type;
    let rows = '';

    if (type === 'ROUND_UP_TRANSFER') {
        const nearest = action.roundToNearest || 100;
        const nearestLabel = nearest >= 100 ? '$' + (nearest / 100).toFixed(0) : (nearest) + '\u00A2';
        rows += detailRow('Round to nearest', nearestLabel);
        rows += detailRow('Destination', 'Savings Account');
        if (action.memo) rows += detailRow('Memo', action.memo);
        // Add example
        const exampleSpend = '$4.30';
        const exampleRound = '$' + (nearest / 100).toFixed(2);
        const exampleSave = '$' + ((nearest - 30) / 100).toFixed(2);
        rows += `<div class="autopilot-rule-example">
            <div class="example-label">Example</div>
            <div class="example-flow">
                <span class="example-step">You spend <strong>${exampleSpend}</strong></span>
                <span class="example-arrow">&#x2192;</span>
                <span class="example-step">Rounded to <strong>${exampleRound}</strong></span>
                <span class="example-arrow">&#x2192;</span>
                <span class="example-step save"><strong>${exampleSave}</strong> saved</span>
            </div>
        </div>`;

    } else if (type === 'TARGET_BALANCE_TRANSFER') {
        const target = action.target ? '$' + (action.target / 100).toFixed(2) : '—';
        const direction = action.direction === 'TO' ? 'Move surplus to pocket' : 'Pull from pocket to cover';
        rows += detailRow('Target balance', target);
        rows += detailRow('Direction', direction);

    } else if (type === 'INTERNAL_TRANSFER') {
        const amount = action.amount ? '$' + (action.amount / 100).toFixed(2) : '—';
        rows += detailRow('Transfer amount', amount);
        if (action.memo) rows += detailRow('Memo', action.memo);

    } else if (type === 'SPLIT_DEPOSIT' && action.destinations) {
        action.destinations.forEach((dest, i) => {
            rows += detailRow('Split ' + (i + 1), dest.percentage + '%');
        });

    } else if (type === 'SPLIT_DEPOSIT_BY_AMOUNT' && action.destinations) {
        action.destinations.forEach((dest, i) => {
            const amt = dest.amount ? '$' + (dest.amount / 100).toFixed(2) : '—';
            rows += detailRow('Split ' + (i + 1), amt);
        });

    } else if (type === 'SEND_NOTIFICATION') {
        if (action.message) rows += detailRow('Message', action.message);
        if (action.method) rows += detailRow('Method', action.method);

    } else if (type === 'SEND_WEBHOOK') {
        if (action.url) rows += detailRow('Webhook URL', action.url);
    }

    return rows;
}

function detailRow(label, value) {
    return `<div class="autopilot-detail-row"><span>${label}</span><span>${value}</span></div>`;
}

async function loadAutoPilotRules() {
    const content = document.getElementById('autopilot-rules-content');
    const badge = document.getElementById('autopilot-rules-badge');
    try {
        const res = await fetch('/api/account/autopilot-rules');
        const data = await res.json();

        if (data.error) {
            content.innerHTML = '<div style="text-align:center; padding:20px; color:var(--alert-red); font-size:13px;">Failed to load rules</div>';
            return;
        }

        // Only show Round Up rules for now
        const rules = (data.rules || []).filter(r =>
            (r.actions || []).some(a => a.type === 'ROUND_UP_TRANSFER')
        );

        // Update badge
        if (badge) {
            const activeCount = rules.filter(r => !r.isPaused && !r.isBroken).length;
            badge.innerHTML = `<span style="background: #d4edda; color: #155724; font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 12px;">${activeCount} Active</span>`;
        }

        if (rules.length === 0) {
            content.innerHTML = `
                <div style="text-align:center; padding:30px 20px; color:var(--text-muted); font-size:14px;">No AutoPilot rules found.</div>
                <div class="autopilot-add-rule" onclick="openCreateRuleForm()">
                    <span style="font-size:18px;">+</span> Add AutoPilot Rule
                </div>
                <div id="autopilot-create-form-container" style="display:none;"></div>`;
            return;
        }

        let html = '<div class="autopilot-rules-list">';
        rules.forEach(rule => {
            // Status
            let statusClass = 'active';
            let statusText = 'Active';
            let statusIcon = '&#x2713;';
            if (rule.isBroken) {
                statusClass = 'broken';
                statusText = 'Needs Attention';
                statusIcon = '&#x26A0;';
            } else if (rule.isPaused) {
                statusClass = 'paused';
                statusText = 'Paused';
                statusIcon = '&#x23F8;';
            }

            // Trigger + action info
            const triggers = rule.triggers || [];
            const actions = rule.actions || [];
            const mainAction = actions[0] || {};
            const mainTrigger = triggers[0] || '';
            const triggerLabel = TRIGGER_LABELS[mainTrigger] || mainTrigger;
            const triggerIcon = TRIGGER_ICONS[mainTrigger] || '&#x26A1;';
            const actionLabel = ACTION_LABELS[mainAction.type] || mainAction.type || '';
            const actionIcon = ACTION_ICONS[mainAction.type] || '&#x2699;';

            // Build detail content for expanded view
            let detailHtml = '';
            // Flow visualization
            detailHtml += `<div class="autopilot-flow">
                <div class="autopilot-flow-step trigger-step">
                    <span class="flow-icon">${triggerIcon}</span>
                    <span class="flow-label">When</span>
                    <span class="flow-value">${triggerLabel}</span>
                </div>
                <div class="autopilot-flow-arrow">&#x25B6;</div>
                <div class="autopilot-flow-step action-step">
                    <span class="flow-icon">${actionIcon}</span>
                    <span class="flow-label">Then</span>
                    <span class="flow-value">${actionLabel}</span>
                </div>
            </div>`;

            // Action-specific details
            actions.forEach(action => {
                detailHtml += buildActionDetail(action);
            });

            // Build linked cards HTML from inline entity data
            const entityCards = rule.entityCards || [];
            let cardsHtml = '';
            if (entityCards.length > 0) {
                entityCards.forEach(card => {
                    const bg = (typeof cardColors !== 'undefined' && cardColors[card.color]) || '#555';
                    const typeLabel = (card.type === 'VIRTUAL' || card.type === 'SINGLE_USE') ? 'Virtual' : 'Physical';
                    const statusLabel = card.status === 'ACTIVATED' ? 'Active' : (card.status || '');
                    cardsHtml += `
                    <div class="rule-card-chip">
                        <div class="rule-card-mini" style="background: linear-gradient(135deg, ${bg} 0%, ${bg}cc 100%);">
                            <div class="rule-card-mini-chip"></div>
                            <div class="rule-card-mini-num">&bull;&bull;${card.lastFour}</div>
                        </div>
                        <div class="rule-card-chip-info">
                            <div class="rule-card-chip-name">${card.name}</div>
                            <div class="rule-card-chip-meta">${typeLabel} &bull; &bull;&bull;${card.lastFour}</div>
                        </div>
                        <div class="rule-card-chip-status"><span class="rule-card-dot active"></span> ${statusLabel}</div>
                    </div>`;
                });
            } else {
                cardsHtml = '<div style="padding:10px; color:var(--text-muted); font-size:12px;">All cards (no specific cards linked)</div>';
            }

            // Store rule data for edit form pre-fill
            const ruleDataAttr = encodeURIComponent(JSON.stringify({
                id: rule.id,
                name: rule.name || 'Round Up',
                roundToNearest: mainAction.roundToNearest || 100,
                accountId: mainAction.accountId || '',
                subaccountId: mainAction.subaccountId || '',
                isPaused: rule.isPaused,
                linkedCardIds: rule.linkedCardIds || [],
                trigger: mainTrigger
            }));

            html += `
            <div class="autopilot-rule-card" data-rule-id="${rule.id}" data-rule-config="${ruleDataAttr}" onclick="toggleRuleDetail(this)">
                <div class="autopilot-rule-header">
                    <div class="autopilot-rule-priority">${rule.priority || '—'}</div>
                    <div class="autopilot-rule-info">
                        <div class="autopilot-rule-name">${rule.name}</div>
                        <div class="autopilot-rule-desc">${rule.description || ''}</div>
                        <div class="autopilot-rule-tags">
                            <span class="autopilot-rule-tag trigger">${triggerIcon} ${triggerLabel}</span>
                            <span class="autopilot-rule-tag action">${actionIcon} ${actionLabel}</span>
                        </div>
                    </div>
                    <div class="autopilot-rule-status ${statusClass}">${statusIcon} ${statusText}</div>
                    <div class="autopilot-rule-chevron" style="transform: rotate(-90deg);">&#x25BC;</div>
                </div>
                <div class="autopilot-rule-detail" style="display:none;">
                    <div class="autopilot-rule-detail-content">
                        ${detailHtml}
                        <div class="autopilot-detail-section-label">Linked Cards</div>
                        <div class="autopilot-cards-container">${cardsHtml}</div>
                        <div class="autopilot-detail-actions">
                            <button class="autopilot-edit-btn" onclick="event.stopPropagation(); openRuleEditForm(this.closest('.autopilot-rule-card'));">Edit Rule</button>
                            <button class="autopilot-delete-btn" onclick="event.stopPropagation(); deleteRule('${rule.id}');">Delete Rule</button>
                        </div>
                    </div>
                    <div class="autopilot-rule-edit-container" style="display:none;"></div>
                </div>
            </div>`;
        });

        // Add "Create Rule" button
        html += `<div class="autopilot-add-rule" onclick="openCreateRuleForm()">
            <span style="font-size:18px;">+</span> Add AutoPilot Rule
        </div>`;
        html += '</div>';

        // Create form container (hidden by default)
        html += '<div id="autopilot-create-form-container" style="display:none;"></div>';
        content.innerHTML = html;

    } catch (err) {
        console.error('Error loading autopilot rules:', err);
        content.innerHTML = '<div style="text-align:center; padding:20px; color:var(--alert-red); font-size:13px;">Network error loading rules</div>';
    }
}

// --- Edit / Create Round Up Rule ---

let _subaccountsCache = null;

async function fetchSubaccounts() {
    if (_subaccountsCache) return _subaccountsCache;
    try {
        const res = await fetch('/api/family-subaccounts');
        const data = await res.json();
        if (!data.error) _subaccountsCache = data;
        return data;
    } catch { return null; }
}

function buildRoundUpForm(opts = {}) {
    const { ruleId, roundToNearest = 100, subaccountId = '', accountId = '', isPaused = false, isCreate = false, linkedCardIds = [], ruleName = 'Round Up' } = opts;
    const amounts = [100, 200, 500, 1000];

    let amountBtns = amounts.map(v => {
        const label = '$' + (v / 100).toFixed(0);
        const sel = v === roundToNearest ? 'selected' : '';
        return `<button type="button" class="roundup-amt-btn ${sel}" data-value="${v}" onclick="selectRoundUpAmount(this)">${label}</button>`;
    }).join('');

    const pauseToggle = !isCreate ? `
        <div class="autopilot-form-group">
            <label class="autopilot-form-label">Status</label>
            <div class="autopilot-toggle-row">
                <span class="autopilot-toggle-label" id="rule-toggle-label">${isPaused ? 'Paused' : 'Active'}</span>
                <label class="autopilot-switch">
                    <input type="checkbox" id="rule-enabled-toggle" ${!isPaused ? 'checked' : ''} onchange="document.getElementById('rule-toggle-label').textContent = this.checked ? 'Active' : 'Paused'">
                    <span class="autopilot-switch-slider"></span>
                </label>
            </div>
        </div>` : '';

    const ruleTypeDropdown = isCreate ? `
        <div class="autopilot-form-group">
            <label class="autopilot-form-label">Rule Type</label>
            <select id="rule-type-select" class="autopilot-form-select" disabled>
                <option value="ROUND_UP" selected>Round Up</option>
            </select>
        </div>` : '';

    return `
    <div class="autopilot-edit-form" onclick="event.stopPropagation();">
        <div class="autopilot-form-title">${isCreate ? 'Create AutoPilot Rule' : 'Edit Rule'}</div>

        <div class="autopilot-form-group">
            <label class="autopilot-form-label">Rule Name</label>
            <input type="text" id="rule-name-input" class="autopilot-form-input" value="${ruleName.replace(/"/g, '&quot;')}" placeholder="e.g. Round Up">
        </div>

        ${ruleTypeDropdown}

        <div class="autopilot-form-group">
            <label class="autopilot-form-label">Round to nearest</label>
            <div class="roundup-amount-options">${amountBtns}</div>
            <input type="hidden" id="rule-round-amount" value="${roundToNearest}">
            <input type="hidden" id="rule-account-id" value="${accountId}">
        </div>

        <div class="autopilot-form-group">
            <label class="autopilot-form-label">Save change to</label>
            <select id="rule-destination-pocket" class="autopilot-form-select" onchange="updateAccountIdFromPocket()">
                <option value="">Loading pockets...</option>
            </select>
        </div>

        <div class="autopilot-form-group">
            <label class="autopilot-form-label">Apply to cards</label>
            <div class="autopilot-form-subtext">Select which cards trigger this round-up rule. If none selected, applies to all cards.</div>
            <div id="rule-card-checkboxes" class="rule-card-checkboxes">
                <div class="autopilot-loading-cards">Loading cards...</div>
            </div>
            <input type="hidden" id="rule-linked-cards" value='${JSON.stringify(linkedCardIds)}'>
        </div>

        ${pauseToggle}

        <div id="rule-form-error" style="display:none; color:var(--alert-red); font-size:13px; padding:8px 12px; background:rgba(211,47,47,0.08); border-radius:8px; margin-bottom:12px;"></div>

        <div class="autopilot-form-actions">
            <button class="autopilot-form-save" id="rule-save-btn" onclick="${isCreate ? 'submitCreateRule()' : `submitEditRule('${ruleId}')`}">
                ${isCreate ? 'Create Rule' : 'Save Changes'}
            </button>
            <button class="autopilot-form-cancel" onclick="${isCreate ? 'cancelCreateRule()' : `cancelEditRule(this.closest('.autopilot-rule-card'))`}">Cancel</button>
        </div>
    </div>`;
}

function selectRoundUpAmount(btn) {
    btn.closest('.roundup-amount-options').querySelectorAll('.roundup-amt-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('rule-round-amount').value = btn.dataset.value;
}

async function populatePocketDropdown(selectedSubaccountId, selectedAccountId) {
    const select = document.getElementById('rule-destination-pocket');
    const data = await fetchSubaccounts();
    if (!data || !data.groups) {
        select.innerHTML = '<option value="">Could not load pockets</option>';
        return;
    }

    let html = '';
    data.groups.forEach(group => {
        html += `<optgroup label="${group.owner || 'Account'}">`;
        group.pockets.forEach(pocket => {
            const displayName = (pocket.name === 'Checking' && group.ownerType === 'main') ? 'Safe-to-Spend' : pocket.name;
            const isSelected = pocket.id === selectedSubaccountId ? 'selected' : '';
            html += `<option value="${pocket.id}" data-account-id="${group.accountId || ''}" ${isSelected}>${displayName}</option>`;
        });
        html += '</optgroup>';
    });
    select.innerHTML = html;

    // If no subaccountId was selected, default to first option
    if (!selectedSubaccountId && select.options.length > 0) {
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value) { select.selectedIndex = i; break; }
        }
    }

    // Update hidden accountId from the selected pocket
    updateAccountIdFromPocket();
}

async function populateCardCheckboxes(selectedCardIds = []) {
    const container = document.getElementById('rule-card-checkboxes');
    try {
        const res = await fetch('/api/cards');
        const data = await res.json();
        if (data.error || !data.cards) {
            container.innerHTML = '<div style="color:var(--text-muted); font-size:13px;">Could not load cards</div>';
            return;
        }

        const physicalCards = data.cards || [];
        if (physicalCards.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted); font-size:13px;">No cards found</div>';
            return;
        }

        let html = '';
        physicalCards.forEach(card => {
            const isChecked = selectedCardIds.includes(card.id) ? 'checked' : '';
            html += `
            <label class="rule-card-checkbox-item" onclick="event.stopPropagation();">
                <input type="checkbox" class="rule-card-cb" value="${card.id}" ${isChecked} onchange="updateLinkedCardsInput()">
                <span class="rule-card-cb-dot" style="background:${card.color ? ({'GREEN':'#2E7D32','BLUE':'#1565C0','RED':'#C62828','PURPLE':'#6A1B9A','BLACK':'#333','GRAY':'#666'}[card.color] || '#333') : '#333'};"></span>
                <span class="rule-card-cb-info">
                    <span class="rule-card-cb-name">${card.holder || 'Card'}</span>
                    <span class="rule-card-cb-meta">..${card.last4}</span>
                </span>
            </label>`;
        });
        container.innerHTML = html;
    } catch (e) {
        container.innerHTML = '<div style="color:var(--text-muted); font-size:13px;">Could not load cards</div>';
    }
}

function updateLinkedCardsInput() {
    const checkboxes = document.querySelectorAll('.rule-card-cb:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('rule-linked-cards').value = JSON.stringify(ids);
}

function updateAccountIdFromPocket() {
    const select = document.getElementById('rule-destination-pocket');
    const hiddenAccountId = document.getElementById('rule-account-id');
    if (select && hiddenAccountId && select.selectedOptions.length > 0) {
        const acctId = select.selectedOptions[0].dataset.accountId;
        if (acctId) hiddenAccountId.value = acctId;
    }
}

async function openRuleEditForm(cardEl) {
    const config = JSON.parse(decodeURIComponent(cardEl.dataset.ruleConfig));
    const detailContent = cardEl.querySelector('.autopilot-rule-detail-content');
    const editContainer = cardEl.querySelector('.autopilot-rule-edit-container');

    detailContent.style.display = 'none';
    editContainer.style.display = 'block';
    editContainer.innerHTML = buildRoundUpForm({
        ruleId: config.id,
        ruleName: config.name || 'Round Up',
        roundToNearest: config.roundToNearest,
        subaccountId: config.subaccountId,
        accountId: config.accountId,
        isPaused: config.isPaused,
        linkedCardIds: config.linkedCardIds || []
    });

    await Promise.all([
        populatePocketDropdown(config.subaccountId, config.accountId),
        populateCardCheckboxes(config.linkedCardIds || [])
    ]);
}

function cancelEditRule(cardEl) {
    const detailContent = cardEl.querySelector('.autopilot-rule-detail-content');
    const editContainer = cardEl.querySelector('.autopilot-rule-edit-container');
    editContainer.style.display = 'none';
    detailContent.style.display = 'block';
}

async function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule? This cannot be undone.')) return;

    try {
        const res = await fetch('/api/account/autopilot-rules/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ruleId })
        });
        const result = await res.json();

        if (result.error) {
            alert('Error deleting rule: ' + result.error);
            return;
        }

        loadAutoPilotRules();
    } catch (err) {
        alert('Network error deleting rule');
    }
}

async function submitEditRule(ruleId) {
    const btn = document.getElementById('rule-save-btn');
    const errorEl = document.getElementById('rule-form-error');
    const ruleName = document.getElementById('rule-name-input').value.trim() || 'Round Up';
    const roundToNearest = parseInt(document.getElementById('rule-round-amount').value);
    const subaccountId = document.getElementById('rule-destination-pocket').value;
    const accountId = document.getElementById('rule-account-id').value;
    const enabledEl = document.getElementById('rule-enabled-toggle');
    const enabled = enabledEl ? enabledEl.checked : true;

    // Get selected card IDs
    const cardIds = JSON.parse(document.getElementById('rule-linked-cards').value || '[]');

    btn.disabled = true;
    btn.textContent = 'Saving...';
    errorEl.style.display = 'none';

    try {
        const res = await fetch('/api/account/autopilot-rules/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ruleId, name: ruleName, accountId, subaccountId, roundToNearest, enabled, cardIds })
        });
        const result = await res.json();

        if (result.error) {
            errorEl.textContent = result.error;
            errorEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Save Changes';
            return;
        }

        // Refresh the rules list
        loadAutoPilotRules();
    } catch (err) {
        errorEl.textContent = 'Network error';
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Save Changes';
    }
}

async function openCreateRuleForm() {
    const container = document.getElementById('autopilot-create-form-container');
    container.style.display = 'block';
    container.innerHTML = buildRoundUpForm({ isCreate: true });
    await Promise.all([
        populatePocketDropdown('', ''),
        populateCardCheckboxes([])
    ]);
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function cancelCreateRule() {
    const container = document.getElementById('autopilot-create-form-container');
    container.style.display = 'none';
    container.innerHTML = '';
}

async function submitCreateRule() {
    const btn = document.getElementById('rule-save-btn');
    const errorEl = document.getElementById('rule-form-error');
    const ruleName = document.getElementById('rule-name-input').value.trim() || 'Round Up';
    const roundToNearest = parseInt(document.getElementById('rule-round-amount').value);
    const subaccountId = document.getElementById('rule-destination-pocket').value;
    const accountId = document.getElementById('rule-account-id').value;

    if (!accountId) {
        errorEl.textContent = 'Please select a destination pocket';
        errorEl.style.display = 'block';
        return;
    }

    // Get selected card IDs
    const cardIds = JSON.parse(document.getElementById('rule-linked-cards').value || '[]');

    btn.disabled = true;
    btn.textContent = 'Creating...';
    errorEl.style.display = 'none';

    try {
        const res = await fetch('/api/account/autopilot-rules/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: ruleName, accountId, subaccountId, roundToNearest, cardIds })
        });
        const result = await res.json();

        if (result.error) {
            errorEl.textContent = result.error;
            errorEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Create Rule';
            return;
        }

        cancelCreateRule();
        loadAutoPilotRules();
    } catch (err) {
        errorEl.textContent = 'Network error';
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Create Rule';
    }
}
</script>

<script>
// Password change form handler
document.getElementById('changePasswordForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const messageDiv = document.getElementById('passwordMessage');

    try {
        const response = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
        });

        const data = await response.json();
        if (data.success) {
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = 'Password updated successfully';
            document.getElementById('changePasswordForm').reset();
        } else {
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = data.error || 'Failed to update password';
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'Network error. Please try again.';
    }
});

// Passkey management functions
async function loadPasskeys() {
    try {
        const response = await fetch('/api/auth/passkeys');
        const data = await response.json();
        const container = document.getElementById('passkeysList');

        if (data.passkeys.length === 0) {
            container.innerHTML = '<p style="color: var(--text-light); text-align: center; font-size: 13px;">No passkeys registered. Add one to enable passwordless login.</p>';
            return;
        }

        container.innerHTML = data.passkeys.map(passkey => `
            <div style="background: var(--bg-elevated); border: 1px solid var(--border-color); border-radius: 8px; padding: 14px 16px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: var(--text-dark); font-size: 14px; margin-bottom: 2px;">${passkey.nickname}</div>
                    <div style="font-size: 12px; color: var(--text-light);">
                        Created: ${new Date(passkey.createdAt).toLocaleDateString()}
                        ${passkey.lastUsedAt ? ` &middot; Last used: ${new Date(passkey.lastUsedAt).toLocaleDateString()}` : ''}
                        ${passkey.isSynced ? ' &middot; Synced' : ''}
                    </div>
                </div>
                <div style="display: flex; gap: 6px;">
                    <button onclick="renamePasskey(${passkey.id})" style="background: transparent; border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; color: var(--text-dark);">Rename</button>
                    <button onclick="deletePasskey(${passkey.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">Remove</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load passkeys:', error);
        document.getElementById('passkeysList').innerHTML = '<p style="color: #dc3545; font-size: 13px;">Failed to load passkeys</p>';
    }
}

function base64urlToUint8Array(base64url) {
    const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const binaryString = atob(base64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes;
}

function uint8ArrayToBase64url(uint8Array) {
    const binaryString = String.fromCharCode(...uint8Array);
    const base64 = btoa(binaryString);
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

document.getElementById('showAddPasskeyBtn')?.addEventListener('click', () => {
    document.getElementById('addPasskeyForm').style.display = 'block';
    document.getElementById('passkeyNickname').value = '';
    document.getElementById('passkeyNickname').focus();
});

document.getElementById('cancelAddPasskeyBtn')?.addEventListener('click', () => {
    document.getElementById('addPasskeyForm').style.display = 'none';
});

document.getElementById('addPasskeyBtn')?.addEventListener('click', async () => {
    const nickname = document.getElementById('passkeyNickname').value.trim();
    if (!nickname) {
        alert('Please enter a nickname for this passkey');
        return;
    }

    try {
        const optionsRes = await fetch('/api/auth/webauthn/register/options', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!optionsRes.ok) {
            const error = await optionsRes.json();
            alert('Failed to get registration options: ' + (error.error || 'Unknown error'));
            return;
        }

        const { sessionId, options } = await optionsRes.json();
        const parsedOptions = JSON.parse(options);

        const publicKey = {
            ...parsedOptions,
            challenge: base64urlToUint8Array(parsedOptions.challenge),
            user: {
                ...parsedOptions.user,
                id: base64urlToUint8Array(parsedOptions.user.id)
            }
        };

        const credential = await navigator.credentials.create({ publicKey });

        const credentialJSON = {
            id: credential.id,
            rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
            type: credential.type,
            response: {
                attestationObject: uint8ArrayToBase64url(new Uint8Array(credential.response.attestationObject)),
                clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                transports: credential.response.getTransports ? credential.response.getTransports() : []
            }
        };

        const verifyRes = await fetch('/api/auth/webauthn/register/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId, credential: credentialJSON, nickname })
        });

        const result = await verifyRes.json();
        if (result.success) {
            alert('Passkey added successfully!');
            document.getElementById('addPasskeyForm').style.display = 'none';
            loadPasskeys();
        } else {
            alert('Failed to add passkey: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to create passkey: ' + error.message + '. Make sure your device supports passkeys.');
    }
});

async function renamePasskey(passkeyId) {
    const nickname = prompt('Enter new name:');
    if (!nickname) return;
    try {
        const response = await fetch(`/api/auth/passkeys/${passkeyId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nickname })
        });
        const result = await response.json();
        if (result.success) loadPasskeys();
        else alert(result.error || 'Failed to rename');
    } catch (error) { alert('Network error'); }
}

async function deletePasskey(passkeyId) {
    if (!confirm('Are you sure you want to remove this passkey?')) return;
    try {
        const response = await fetch(`/api/auth/passkeys/${passkeyId}`, { method: 'DELETE' });
        const result = await response.json();
        if (result.success) loadPasskeys();
        else alert(result.error || 'Failed to delete');
    } catch (error) { alert('Network error'); }
}

if (document.getElementById('passkeysList')) {
    loadPasskeys();
}

// WebAuthn Configuration
async function loadWebAuthnConfig() {
    try {
        const response = await fetch('/api/account/webauthn/config');
        const data = await response.json();
        document.getElementById('webauthnRpId').value = data.rp_id || '';
        document.getElementById('webauthnOrigin').value = data.origin || '';
    } catch (error) {
        console.error('Failed to load WebAuthn config:', error);
    }
}

async function testWebAuthnConfig() {
    const rpId = document.getElementById('webauthnRpId').value;
    const origin = document.getElementById('webauthnOrigin').value;
    const messageDiv = document.getElementById('webauthnConfigMessage');
    try {
        const response = await fetch('/api/account/webauthn/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rp_id: rpId, origin: origin })
        });
        const data = await response.json();
        messageDiv.style.display = 'block';
        if (data.success) {
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = data.message;
        } else {
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = data.error;
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'Network error. Please try again.';
    }
}

document.getElementById('webauthnConfigForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const rpId = document.getElementById('webauthnRpId').value;
    const origin = document.getElementById('webauthnOrigin').value;
    const messageDiv = document.getElementById('webauthnConfigMessage');
    try {
        const response = await fetch('/api/account/webauthn/update-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rp_id: rpId, origin: origin })
        });
        const data = await response.json();
        messageDiv.style.display = 'block';
        if (data.success) {
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = data.message;
        } else {
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = data.error;
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'Network error. Please try again.';
    }
});

if (document.getElementById('webauthnConfigForm')) {
    loadWebAuthnConfig();
}
</script>
