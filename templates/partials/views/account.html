<div id="view-account" class="view-section">
    <div class="section-header-row"><span class="tab-title">My Account</span></div>
    <div class="data-container" style="padding: 40px 20px;">
        <div style="max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 40px;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚öôÔ∏è</div>
                <h1 style="font-size: 32px; font-weight: 600; color: var(--text-dark); margin-bottom: 10px;">Account Settings</h1>
                <p style="font-size: 18px; color: var(--text-light); line-height: 1.6;">
                    Manage your API credentials and account configuration.
                </p>
            </div>

            <!-- Crew Banking Configuration -->
            <div style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 36px;">üè¶</div>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-dark); margin: 0;">Crew Banking</h3>
                            <p style="font-size: 14px; color: var(--text-light); margin: 4px 0 0 0;">Primary banking connection</p>
                        </div>
                    </div>
                    <div id="crew-status-badge"></div>
                </div>

                <div id="crew-config-form" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Bearer Token</label>
                        <input type="password" id="crew-token-input" placeholder="Enter Crew bearer token" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark);">
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                            Find this in your Crew account settings under API access.
                        </p>
                    </div>
                    <div id="crew-error" style="background: #fee; color: #c00; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;"></div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="saveCrewToken()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Save Token
                        </button>
                        <button onclick="cancelCrewEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="crew-config-display" style="display: none;">
                    <div style="display: flex; gap: 12px;">
                        <button onclick="editCrewToken()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Update Token
                        </button>
                        <button onclick="testCrewConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Test Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- SimpleFin Configuration -->
            <div style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 36px;">üîê</div>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-dark); margin: 0;">SimpleFin</h3>
                            <p style="font-size: 14px; color: var(--text-light); margin: 4px 0 0 0;">Credit card transaction sync</p>
                        </div>
                    </div>
                    <div id="simplefin-status-badge"></div>
                </div>

                <div id="simplefin-config-form" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Setup Token</label>
                        <input type="password" id="simplefin-token-input" placeholder="Enter SimpleFin setup token" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark);">
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                            Get your setup token from <a href="https://bridge.simplefin.org/simplefin/claim" target="_blank" style="color: var(--simple-blue);">SimpleFin Bridge</a>.
                        </p>
                    </div>
                    <div id="simplefin-error" style="background: #fee; color: #c00; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;"></div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="saveSimpleFinToken()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Save Token
                        </button>
                        <button onclick="cancelSimpleFinEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="simplefin-config-display" style="display: none;">
                    <div style="display: flex; gap: 12px;">
                        <button onclick="editSimpleFinToken()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Update Token
                        </button>
                        <button onclick="testSimpleFinConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Test Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- LunchFlow Configuration -->
            <div style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 36px;">üç±</div>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-dark); margin: 0;">LunchFlow</h3>
                            <p style="font-size: 14px; color: var(--text-light); margin: 4px 0 0 0;">Alternative credit card sync</p>
                        </div>
                    </div>
                    <div id="lunchflow-status-badge"></div>
                </div>

                <div id="lunchflow-config-form" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">API Key</label>
                        <input type="password" id="lunchflow-apikey-input" placeholder="Enter LunchFlow API key" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark);">
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                            Get your API key from <a href="https://lunchflow.app" target="_blank" style="color: var(--simple-blue);">LunchFlow Dashboard</a>.
                        </p>
                    </div>
                    <div id="lunchflow-account-error" style="background: #fee; color: #c00; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;"></div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="saveLunchFlowKey()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Save API Key
                        </button>
                        <button onclick="cancelLunchFlowEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="lunchflow-config-display" style="display: none;">
                    <div style="display: flex; gap: 12px;">
                        <button onclick="editLunchFlowKey()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Update API Key
                        </button>
                        <button onclick="testLunchFlowConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Test Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Splitwise Configuration -->
            <div style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 36px;">üìä</div>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-dark); margin: 0;">Splitwise</h3>
                            <p style="font-size: 14px; color: var(--text-light); margin: 4px 0 0 0;">Expense sharing integration</p>
                        </div>
                    </div>
                    <div id="splitwise-status-badge"></div>
                </div>

                <div id="splitwise-config-form" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">API Key</label>
                        <input type="password" id="splitwise-apikey-input" placeholder="Enter Splitwise API key" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark);">
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                            Get your API key from <a href="https://secure.splitwise.com/apps" target="_blank" style="color: var(--simple-blue);">Splitwise Apps</a> (register an app to get an API key).
                        </p>
                    </div>
                    <div id="splitwise-account-error" style="background: #fee; color: #c00; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;"></div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="saveSplitwiseKey()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Save API Key
                        </button>
                        <button onclick="cancelSplitwiseEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="splitwise-config-display" style="display: none;">
                    <div style="display: flex; gap: 12px;">
                        <button onclick="editSplitwiseKey()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Update API Key
                        </button>
                        <button onclick="testSplitwiseConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Test Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Security Section -->
            <div style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 36px;">üîí</div>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-dark); margin: 0;">Security</h3>
                            <p style="font-size: 14px; color: var(--text-light); margin: 4px 0 0 0;">Update your account password</p>
                        </div>
                    </div>
                </div>

                <form id="changePasswordForm" style="max-width: 500px;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Current Password</label>
                        <input type="password" id="currentPassword" placeholder="Enter current password" required style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark);">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password (min. 8 characters)" required style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark);">
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                            Password must be at least 8 characters long.
                        </p>
                    </div>
                    <div id="passwordMessage" style="padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;"></div>
                    <button type="submit" style="background: var(--simple-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                        Update Password
                    </button>
                </form>
            </div>

            <!-- Passkey Management Section -->
            <div style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 36px;">üîë</div>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-dark); margin: 0;">Passkeys</h3>
                            <p style="font-size: 14px; color: var(--text-light); margin: 4px 0 0 0;">Passwordless login with Face ID, Touch ID, or security keys</p>
                        </div>
                    </div>
                    <button id="showAddPasskeyBtn" style="background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        + Add Passkey
                    </button>
                </div>

                <!-- Add Passkey Form (hidden by default) -->
                <div id="addPasskeyForm" style="display: none; background: var(--bg-elevated); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin: 0 0 16px 0;">Add New Passkey</h4>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 14px;">Nickname</label>
                        <input type="text" id="passkeyNickname" placeholder='e.g., "My iPhone", "Security Key"' style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button id="addPasskeyBtn" style="background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; flex: 1;">
                            Create Passkey
                        </button>
                        <button id="cancelAddPasskeyBtn" style="background: transparent; color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="passkeysList" style="margin-top: 20px;">
                    <p style="color: var(--text-light); text-align: center;">Loading passkeys...</p>
                </div>
            </div>

            <!-- WebAuthn Configuration Section -->
            <div style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 36px;">‚öôÔ∏è</div>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-dark); margin: 0;">Passkey Configuration</h3>
                            <p style="font-size: 14px; color: var(--text-light); margin: 4px 0 0 0;">Configure domain settings for passkey authentication</p>
                        </div>
                    </div>
                </div>

                <div style="max-width: 600px;">
                    <div style="background: var(--bg-elevated); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="font-size: 20px;">‚ÑπÔ∏è</div>
                            <div style="font-size: 13px; color: var(--text-light); line-height: 1.5;">
                                <strong style="color: var(--text-dark);">For localhost development:</strong> Use <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px;">localhost</code> and <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px;">http://localhost:8080</code><br>
                                <strong style="color: var(--text-dark); margin-top: 8px; display: block;">For production:</strong> Use your domain (e.g., <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px;">example.com</code>) and HTTPS URL (e.g., <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px;">https://example.com</code>)
                            </div>
                        </div>
                    </div>

                    <form id="webauthnConfigForm">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">
                                Relying Party ID (RP_ID)
                                <span style="font-weight: normal; color: var(--text-light); font-size: 13px;">‚Äî Your domain name</span>
                            </label>
                            <input type="text" id="webauthnRpId" placeholder="localhost" required style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark);">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">
                                Origin URL
                                <span style="font-weight: normal; color: var(--text-light); font-size: 13px;">‚Äî Your full application URL</span>
                            </label>
                            <input type="text" id="webauthnOrigin" placeholder="http://localhost:8080" required style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark);">
                        </div>
                        <div id="webauthnConfigMessage" style="padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;"></div>
                        <div style="display: flex; gap: 12px;">
                            <button type="submit" style="background: var(--simple-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                Save Configuration
                            </button>
                            <button type="button" onclick="testWebAuthnConfig()" style="background: var(--bg-elevated); color: var(--text-dark); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                                Test Configuration
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Section -->
            <div style="background: var(--bg-elevated); border-radius: 12px; padding: 24px; margin-top: 32px;">
                <h4 style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin: 0 0 12px 0;">üí° Security Note</h4>
                <p style="font-size: 14px; color: var(--text-light); line-height: 1.6; margin: 0;">
                    Your credentials are stored securely in your local database and are never transmitted except when validating against the respective APIs.
                    Always keep your API keys and tokens private.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Password change form handler
document.getElementById('changePasswordForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const messageDiv = document.getElementById('passwordMessage');

    try {
        const response = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
        });

        const data = await response.json();
        if (data.success) {
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = '‚úì Password updated successfully';
            document.getElementById('changePasswordForm').reset();
        } else {
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = '‚úó ' + (data.error || 'Failed to update password');
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = '‚úó Network error. Please try again.';
    }
});

// Passkey management functions
async function loadPasskeys() {
    try {
        const response = await fetch('/api/auth/passkeys');
        const data = await response.json();

        const container = document.getElementById('passkeysList');

        if (data.passkeys.length === 0) {
            container.innerHTML = '<p style="color: var(--text-light); text-align: center;">No passkeys registered. Add one to enable passwordless login!</p>';
            return;
        }

        container.innerHTML = data.passkeys.map(passkey => `
            <div style="background: var(--bg-elevated); border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px;">${passkey.nickname}</div>
                    <div style="font-size: 13px; color: var(--text-light);">
                        Created: ${new Date(passkey.createdAt).toLocaleDateString()}
                        ${passkey.lastUsedAt ? ` ‚Ä¢ Last used: ${new Date(passkey.lastUsedAt).toLocaleDateString()}` : ''}
                        ${passkey.isSynced ? ' ‚Ä¢ üîÑ Synced' : ''}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="renamePasskey(${passkey.id})" style="background: transparent; border: 2px solid var(--border-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        Rename
                    </button>
                    <button onclick="deletePasskey(${passkey.id})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        Remove
                    </button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Failed to load passkeys:', error);
        document.getElementById('passkeysList').innerHTML = '<p style="color: #dc3545;">Failed to load passkeys</p>';
    }
}

// Helper function to decode base64url to Uint8Array
function base64urlToUint8Array(base64url) {
    // Convert base64url to base64
    const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    // Decode base64 to binary string
    const binaryString = atob(base64);
    // Convert binary string to Uint8Array
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes;
}

// Helper function to encode Uint8Array to base64url
function uint8ArrayToBase64url(uint8Array) {
    const binaryString = String.fromCharCode(...uint8Array);
    const base64 = btoa(binaryString);
    // Convert base64 to base64url
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

// Show/hide add passkey form
document.getElementById('showAddPasskeyBtn')?.addEventListener('click', () => {
    document.getElementById('addPasskeyForm').style.display = 'block';
    document.getElementById('passkeyNickname').value = '';
    document.getElementById('passkeyNickname').focus();
});

document.getElementById('cancelAddPasskeyBtn')?.addEventListener('click', () => {
    document.getElementById('addPasskeyForm').style.display = 'none';
});

// Add passkey - NO PROMPT, direct from button click
document.getElementById('addPasskeyBtn')?.addEventListener('click', async () => {
    const nickname = document.getElementById('passkeyNickname').value.trim();
    if (!nickname) {
        alert('Please enter a nickname for this passkey');
        return;
    }

    console.log('[Passkey Registration] Starting passkey registration...');
    console.log('[Passkey Registration] Nickname:', nickname);
    console.log('[Passkey Registration] User agent:', navigator.userAgent);
    console.log('[Passkey Registration] WebAuthn support:', !!navigator.credentials);

    try {
        console.log('[Passkey Registration] Step 1: Requesting registration options...');
        // Get registration options
        const optionsRes = await fetch('/api/auth/webauthn/register/options', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        console.log('[Passkey Registration] Options response status:', optionsRes.status);

        if (!optionsRes.ok) {
            const error = await optionsRes.json();
            console.error('[Passkey Registration] ERROR getting options:', error);
            alert('Failed to get registration options: ' + (error.error || 'Unknown error'));
            return;
        }

        const { sessionId, options } = await optionsRes.json();
        console.log('[Passkey Registration] Session ID:', sessionId);
        console.log('[Passkey Registration] Options received:', options.substring(0, 100) + '...');

        console.log('[Passkey Registration] Step 2: Parsing options...');
        // Parse options and convert base64url strings to Uint8Arrays
        const parsedOptions = JSON.parse(options);
        console.log('[Passkey Registration] Challenge length:', parsedOptions.challenge.length);
        console.log('[Passkey Registration] User ID length:', parsedOptions.user.id.length);

        const publicKey = {
            ...parsedOptions,
            challenge: base64urlToUint8Array(parsedOptions.challenge),
            user: {
                ...parsedOptions.user,
                id: base64urlToUint8Array(parsedOptions.user.id)
            }
        };

        console.log('[Passkey Registration] Step 3: Creating credential...');
        // Create credential
        const credential = await navigator.credentials.create({ publicKey });
        console.log('[Passkey Registration] Credential created:', credential.id.substring(0, 20) + '...');
        console.log('[Passkey Registration] Credential type:', credential.type);

        console.log('[Passkey Registration] Step 4: Preparing credential for server...');
        // Prepare credential for server (convert Uint8Arrays back to base64url)
        const credentialJSON = {
            id: credential.id,
            rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
            type: credential.type,
            response: {
                attestationObject: uint8ArrayToBase64url(new Uint8Array(credential.response.attestationObject)),
                clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                transports: credential.response.getTransports ? credential.response.getTransports() : []
            }
        };

        console.log('[Passkey Registration] Transports:', credentialJSON.response.transports);

        console.log('[Passkey Registration] Step 5: Verifying with server...');
        // Verify with server
        const verifyRes = await fetch('/api/auth/webauthn/register/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId, credential: credentialJSON, nickname })
        });

        console.log('[Passkey Registration] Verify response status:', verifyRes.status);

        const result = await verifyRes.json();
        if (result.success) {
            console.log('[Passkey Registration] SUCCESS! Passkey registered.');
            alert('Passkey added successfully!');
            document.getElementById('addPasskeyForm').style.display = 'none';
            loadPasskeys();
        } else {
            console.error('[Passkey Registration] ERROR: Verification failed:', result.error);
            alert('Failed to add passkey: ' + (result.error || 'Unknown error'));
        }

    } catch (error) {
        console.error('[Passkey Registration] EXCEPTION:', error.name, error.message);
        console.error('[Passkey Registration] Stack trace:', error.stack);
        alert('Failed to create passkey: ' + error.message + '. Make sure your device supports passkeys.');
    }
});

// Rename passkey
async function renamePasskey(passkeyId) {
    const nickname = prompt('Enter new name:');
    if (!nickname) return;

    try {
        const response = await fetch(`/api/auth/passkeys/${passkeyId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nickname })
        });

        const result = await response.json();
        if (result.success) {
            loadPasskeys();
        } else {
            alert(result.error || 'Failed to rename');
        }
    } catch (error) {
        alert('Network error');
    }
}

// Delete passkey
async function deletePasskey(passkeyId) {
    if (!confirm('Are you sure you want to remove this passkey?')) return;

    try {
        const response = await fetch(`/api/auth/passkeys/${passkeyId}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        if (result.success) {
            loadPasskeys();
        } else {
            alert(result.error || 'Failed to delete');
        }
    } catch (error) {
        alert('Network error');
    }
}

// Load passkeys when account tab is opened
if (document.getElementById('passkeysList')) {
    loadPasskeys();
}

// WebAuthn Configuration Management
async function loadWebAuthnConfig() {
    try {
        const response = await fetch('/api/account/webauthn/config');
        const data = await response.json();

        document.getElementById('webauthnRpId').value = data.rp_id || '';
        document.getElementById('webauthnOrigin').value = data.origin || '';
    } catch (error) {
        console.error('Failed to load WebAuthn config:', error);
    }
}

// Test WebAuthn configuration
async function testWebAuthnConfig() {
    const rpId = document.getElementById('webauthnRpId').value;
    const origin = document.getElementById('webauthnOrigin').value;
    const messageDiv = document.getElementById('webauthnConfigMessage');

    try {
        const response = await fetch('/api/account/webauthn/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rp_id: rpId, origin: origin })
        });

        const data = await response.json();
        messageDiv.style.display = 'block';

        if (data.success) {
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = '‚úì ' + data.message;
        } else {
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = '‚úó ' + data.error;
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = '‚úó Network error. Please try again.';
    }
}

// Save WebAuthn configuration
document.getElementById('webauthnConfigForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const rpId = document.getElementById('webauthnRpId').value;
    const origin = document.getElementById('webauthnOrigin').value;
    const messageDiv = document.getElementById('webauthnConfigMessage');

    try {
        const response = await fetch('/api/account/webauthn/update-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rp_id: rpId, origin: origin })
        });

        const data = await response.json();
        messageDiv.style.display = 'block';

        if (data.success) {
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = '‚úì ' + data.message;
        } else {
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = '‚úó ' + data.error;
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = '‚úó Network error. Please try again.';
    }
});

// Load WebAuthn config when account tab is opened
if (document.getElementById('webauthnConfigForm')) {
    loadWebAuthnConfig();
}
</script>
