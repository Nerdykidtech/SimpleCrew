<div id="view-account" class="view-section">
    <div class="section-header-row"><span class="tab-title">My Account</span></div>
    <div class="data-container" style="padding: 24px 20px;">
        <div style="max-width: 700px; margin: 0 auto;">

            <!-- Account Information -->
            <div class="settings-category-label">Account</div>

            <!-- Bank Account Details -->
            <div class="settings-section collapsed" id="bank-details-section">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9); color: #2E7D32;">&#x1f3e6;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Bank Account Details</div>
                        <div class="settings-section-subtitle">Account & routing numbers</div>
                    </div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="bank-details-content">
                        <p style="font-size: 13px; color: var(--text-muted); margin: 12px 0;">Tap the eye icon to reveal your account details.</p>
                        <div id="bank-details-loading" style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">Loading account details...</div>
                        <div id="bank-details-data" style="display: none;">
                            <div class="bank-account-card">
                                <div class="bank-account-card-title">
                                    <span style="font-size: 16px;">&#x1f4b3;</span> Crew Account
                                </div>
                                <div class="bank-detail-row">
                                    <span class="bank-detail-label">Main Account #</span>
                                    <div class="bank-detail-value">
                                        <span id="spend-account-num" class="bank-detail-hidden">&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;</span>
                                        <button class="bank-reveal-btn" onclick="toggleBankDetail('spend-account-num', event)">Show</button>
                                    </div>
                                </div>
                                <div class="bank-detail-row">
                                    <span class="bank-detail-label">Main Routing #</span>
                                    <div class="bank-detail-value">
                                        <span id="spend-routing-num" class="bank-detail-hidden">&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;</span>
                                        <button class="bank-reveal-btn" onclick="toggleBankDetail('spend-routing-num', event)">Show</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="bank-details-error" style="display: none; color: #c00; font-size: 13px; padding: 12px; background: #fee; border-radius: 8px; margin-top: 12px;"></div>
                    </div>
                </div>
            </div>

            <!-- API Connections -->
            <div class="settings-category-label">Connections</div>

            <!-- Crew Banking -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #E3F2FD, #BBDEFB); color: #1565C0;">&#x1f3e6;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Crew Banking</div>
                        <div class="settings-section-subtitle">Primary banking connection</div>
                    </div>
                    <div class="settings-section-badge" id="crew-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="crew-config-form" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 13px;">Bearer Token</label>
                            <input type="password" id="crew-token-input" placeholder="Enter Crew bearer token" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">Find this in your Crew account settings under API access.</p>
                        </div>
                        <div id="crew-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveCrewToken()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save Token</button>
                            <button onclick="cancelCrewEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="crew-config-display" style="display: none; margin-top: 16px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editCrewToken()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update Token</button>
                            <button onclick="testCrewConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SimpleFin -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #F3E5F5, #E1BEE7); color: #7B1FA2;">&#x1f510;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">SimpleFin</div>
                        <div class="settings-section-subtitle">Credit card transaction sync</div>
                    </div>
                    <div class="settings-section-badge" id="simplefin-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="simplefin-config-form" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 13px;">Setup Token</label>
                            <input type="password" id="simplefin-token-input" placeholder="Enter SimpleFin setup token" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">Get your setup token from <a href="https://bridge.simplefin.org/simplefin/claim" target="_blank" style="color: var(--simple-blue);">SimpleFin Bridge</a>.</p>
                        </div>
                        <div id="simplefin-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveSimpleFinToken()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save Token</button>
                            <button onclick="cancelSimpleFinEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="simplefin-config-display" style="display: none; margin-top: 16px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editSimpleFinToken()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update Token</button>
                            <button onclick="testSimpleFinConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LunchFlow -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2); color: #E65100;">&#x1f371;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">LunchFlow</div>
                        <div class="settings-section-subtitle">Alternative credit card sync</div>
                    </div>
                    <div class="settings-section-badge" id="lunchflow-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="lunchflow-config-form" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 13px;">API Key</label>
                            <input type="password" id="lunchflow-apikey-input" placeholder="Enter LunchFlow API key" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">Get your API key from <a href="https://lunchflow.app" target="_blank" style="color: var(--simple-blue);">LunchFlow Dashboard</a>.</p>
                        </div>
                        <div id="lunchflow-account-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveLunchFlowKey()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save API Key</button>
                            <button onclick="cancelLunchFlowEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="lunchflow-config-display" style="display: none; margin-top: 16px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editLunchFlowKey()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update API Key</button>
                            <button onclick="testLunchFlowConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Splitwise -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9); color: #2E7D32;">&#x1f4ca;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Splitwise</div>
                        <div class="settings-section-subtitle">Expense sharing integration</div>
                    </div>
                    <div class="settings-section-badge" id="splitwise-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div id="splitwise-config-form" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 13px;">API Key</label>
                            <input type="password" id="splitwise-apikey-input" placeholder="Enter Splitwise API key" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">Get your API key from <a href="https://secure.splitwise.com/apps" target="_blank" style="color: var(--simple-blue);">Splitwise Apps</a>.</p>
                        </div>
                        <div id="splitwise-account-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveSplitwiseKey()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save API Key</button>
                            <button onclick="cancelSplitwiseEdit()" style="flex: 1; background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="splitwise-config-display" style="display: none; margin-top: 16px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editSplitwiseKey()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update API Key</button>
                            <button onclick="testSplitwiseConnection()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="settings-category-label">Notifications</div>

            <!-- Push Notifications -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #FFF8E1, #FFECB3); color: #F57F17;">&#x1f514;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Push Notifications</div>
                        <div class="settings-section-subtitle">Credit card sync alerts</div>
                    </div>
                    <div class="settings-section-badge" id="notification-status"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <p style="font-size: 13px; color: var(--text-dark); margin: 12px 0 16px 0;">
                        Enable push notifications to receive alerts when new transactions are synced from your credit cards.
                    </p>
                    <button onclick="requestNotificationPermission()"
                            style="background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        Enable Notifications
                    </button>
                </div>
            </div>

            <!-- VAPID Configuration -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #E0F7FA, #B2EBF2); color: #00838F;">&#x1f511;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">VAPID Keys</div>
                        <div class="settings-section-subtitle">Web Push authentication</div>
                    </div>
                    <div class="settings-section-badge" id="fcm-config-status-badge"></div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div style="background: var(--bg-elevated); border-left: 3px solid var(--simple-blue); padding: 12px 16px; border-radius: 4px; margin: 12px 0 16px 0;">
                        <p style="font-size: 12px; color: var(--text-dark); margin: 0; line-height: 1.6;">
                            <strong>Setup:</strong> Generate keys at <a href="https://vapidkeys.com" target="_blank" style="color: var(--simple-blue);">vapidkeys.com</a>
                            or run <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; font-size: 11px;">npx web-push generate-vapid-keys</code>
                        </p>
                    </div>
                    <div id="fcm-config-form">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">VAPID Public Key</label>
                            <input type="text" id="fcm-vapid-public" placeholder="Enter VAPID public key"
                                   style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">VAPID Private Key</label>
                            <input type="password" id="fcm-vapid-private" placeholder="Enter VAPID private key"
                                   style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 13px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div id="fcm-config-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveFcmConfig()" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save Configuration</button>
                            <button onclick="testFcmConfig()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Send Test</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security -->
            <div class="settings-category-label">Security</div>

            <!-- Change Password -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #FCE4EC, #F8BBD0); color: #C62828;">&#x1f512;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Password</div>
                        <div class="settings-section-subtitle">Update your account password</div>
                    </div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <form id="changePasswordForm" style="margin-top: 12px;">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">New Password</label>
                            <input type="password" id="newPassword" placeholder="Min. 8 characters" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div id="passwordMessage" style="padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <button type="submit" style="background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Update Password</button>
                    </form>
                </div>
            </div>

            <!-- Passkeys -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #EDE7F6, #D1C4E9); color: #4527A0;">&#x1f511;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Passkeys</div>
                        <div class="settings-section-subtitle">Face ID, Touch ID, or security keys</div>
                    </div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div style="display: flex; justify-content: flex-end; margin-top: 12px; margin-bottom: 12px;">
                        <button id="showAddPasskeyBtn" style="background: var(--simple-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">+ Add Passkey</button>
                    </div>
                    <div id="addPasskeyForm" style="display: none; background: var(--bg-elevated); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: var(--text-dark); margin: 0 0 12px 0;">Add New Passkey</h4>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">Nickname</label>
                            <input type="text" id="passkeyNickname" placeholder='e.g., "My iPhone", "Security Key"' style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="addPasskeyBtn" style="background: var(--simple-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; flex: 1;">Create Passkey</button>
                            <button id="cancelAddPasskeyBtn" style="background: transparent; color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="passkeysList">
                        <p style="color: var(--text-light); text-align: center; font-size: 13px;">Loading passkeys...</p>
                    </div>
                </div>
            </div>

            <!-- Passkey Configuration -->
            <div class="settings-section collapsed">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <div class="settings-section-icon" style="background: linear-gradient(135deg, #ECEFF1, #CFD8DC); color: #37474F;">&#x2699;&#xFE0F;</div>
                    <div class="settings-section-info">
                        <div class="settings-section-title">Passkey Configuration</div>
                        <div class="settings-section-subtitle">Domain settings for WebAuthn</div>
                    </div>
                    <div class="settings-section-chevron">&#x25BC;</div>
                </div>
                <div class="settings-section-body">
                    <div style="background: var(--bg-elevated); border-radius: 8px; padding: 12px 16px; margin: 12px 0 16px 0;">
                        <p style="font-size: 12px; color: var(--text-light); line-height: 1.5; margin: 0;">
                            <strong style="color: var(--text-dark);">Localhost:</strong> <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; font-size: 11px;">localhost</code> / <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; font-size: 11px;">http://localhost:8080</code><br>
                            <strong style="color: var(--text-dark);">Production:</strong> Your domain and HTTPS URL
                        </p>
                    </div>
                    <form id="webauthnConfigForm">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">
                                Relying Party ID <span style="font-weight: normal; color: var(--text-light); font-size: 12px;">- domain name</span>
                            </label>
                            <input type="text" id="webauthnRpId" placeholder="localhost" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 13px;">
                                Origin URL <span style="font-weight: normal; color: var(--text-light); font-size: 12px;">- full app URL</span>
                            </label>
                            <input type="text" id="webauthnOrigin" placeholder="http://localhost:8080" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-dark); box-sizing: border-box;">
                        </div>
                        <div id="webauthnConfigMessage" style="padding: 10px; border-radius: 8px; margin-bottom: 12px; display: none; font-size: 13px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" style="flex: 1; background: var(--simple-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Save Configuration</button>
                            <button type="button" onclick="testWebAuthnConfig()" style="background: var(--bg-elevated); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">Test</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Note -->
            <div style="background: var(--bg-elevated); border-radius: 10px; padding: 16px 20px; margin-top: 24px;">
                <p style="font-size: 12px; color: var(--text-light); line-height: 1.6; margin: 0;">
                    <strong style="color: var(--text-dark);">Security Note</strong> &mdash; Your credentials are stored securely in your local database and are never transmitted except when validating against the respective APIs.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Accordion toggle
function toggleSettingsSection(headerEl) {
    const section = headerEl.closest('.settings-section');
    section.classList.toggle('collapsed');
}

// Bank detail reveal/hide
const bankDetailData = {};
function toggleBankDetail(id, event) {
    event.stopPropagation();
    const el = document.getElementById(id);
    const btn = event.target;

    if (el.dataset.revealed === 'true') {
        el.textContent = '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022';
        el.classList.add('bank-detail-hidden');
        el.dataset.revealed = 'false';
        btn.textContent = 'Show';
    } else {
        const val = bankDetailData[id];
        if (val) {
            el.textContent = val;
            el.classList.remove('bank-detail-hidden');
            el.dataset.revealed = 'true';
            btn.textContent = 'Hide';
        }
    }
}

// Fetch bank account details
async function loadBankAccountDetails() {
    const loadingEl = document.getElementById('bank-details-loading');
    const dataEl = document.getElementById('bank-details-data');
    const errorEl = document.getElementById('bank-details-error');

    try {
        const response = await fetch('/api/account/bank-details');
        const data = await response.json();

        if (data.success) {
            bankDetailData['spend-account-num'] = data.spendAccountNumber || 'N/A';
            bankDetailData['spend-routing-num'] = data.spendRoutingNumber || 'N/A';

            loadingEl.style.display = 'none';
            dataEl.style.display = 'block';
        } else {
            loadingEl.style.display = 'none';
            errorEl.textContent = data.error || 'Failed to load bank details';
            errorEl.style.display = 'block';
        }
    } catch (error) {
        loadingEl.style.display = 'none';
        errorEl.textContent = 'Could not load bank details. Ensure Crew Banking is configured.';
        errorEl.style.display = 'block';
    }
}

// Load FCM config status
async function loadFcmConfigStatus() {
    try {
        const response = await fetch('/api/account/fcm/config');
        const data = await response.json();
        const badgeEl = document.getElementById('fcm-config-status-badge');
        if (data.configured) {
            badgeEl.innerHTML = '<span style="background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">Configured</span>';
        } else {
            badgeEl.innerHTML = '<span style="background: #e9ecef; color: #6c757d; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">Not Set</span>';
        }
    } catch (error) {
        console.error('Failed to load FCM config status:', error);
    }
}

async function saveFcmConfig() {
    const errorEl = document.getElementById('fcm-config-error');
    try {
        const config = {
            vapid_public_key: document.getElementById('fcm-vapid-public').value.trim(),
            vapid_private_key: document.getElementById('fcm-vapid-private').value.trim()
        };
        if (!config.vapid_public_key || !config.vapid_private_key) {
            errorEl.textContent = 'Both VAPID keys are required';
            errorEl.style.display = 'block';
            return;
        }
        errorEl.style.display = 'none';
        const response = await fetch('/api/account/fcm/update-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        const data = await response.json();
        if (data.success) {
            appAlert('VAPID configuration saved successfully', 'Success');
            loadFcmConfigStatus();
            document.getElementById('fcm-vapid-private').value = '';
        } else {
            errorEl.textContent = data.error || 'Failed to save configuration';
            errorEl.style.display = 'block';
        }
    } catch (error) {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.style.display = 'block';
    }
}

async function testFcmConfig() {
    try {
        const response = await fetch('/api/account/fcm/test', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            appAlert('Test notification sent! Check your browser.', 'Success');
        } else {
            appAlert('Failed: ' + data.error, 'Error');
        }
    } catch (error) {
        appAlert('Network error', 'Error');
    }
}

// Init on load
if (document.getElementById('fcm-config-status-badge')) {
    loadFcmConfigStatus();
}
if (document.getElementById('bank-details-section')) {
    loadBankAccountDetails();
}
</script>

<script>
// Password change form handler
document.getElementById('changePasswordForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const messageDiv = document.getElementById('passwordMessage');

    try {
        const response = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
        });

        const data = await response.json();
        if (data.success) {
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = 'Password updated successfully';
            document.getElementById('changePasswordForm').reset();
        } else {
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = data.error || 'Failed to update password';
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'Network error. Please try again.';
    }
});

// Passkey management functions
async function loadPasskeys() {
    try {
        const response = await fetch('/api/auth/passkeys');
        const data = await response.json();
        const container = document.getElementById('passkeysList');

        if (data.passkeys.length === 0) {
            container.innerHTML = '<p style="color: var(--text-light); text-align: center; font-size: 13px;">No passkeys registered. Add one to enable passwordless login.</p>';
            return;
        }

        container.innerHTML = data.passkeys.map(passkey => `
            <div style="background: var(--bg-elevated); border: 1px solid var(--border-color); border-radius: 8px; padding: 14px 16px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: var(--text-dark); font-size: 14px; margin-bottom: 2px;">${passkey.nickname}</div>
                    <div style="font-size: 12px; color: var(--text-light);">
                        Created: ${new Date(passkey.createdAt).toLocaleDateString()}
                        ${passkey.lastUsedAt ? ` &middot; Last used: ${new Date(passkey.lastUsedAt).toLocaleDateString()}` : ''}
                        ${passkey.isSynced ? ' &middot; Synced' : ''}
                    </div>
                </div>
                <div style="display: flex; gap: 6px;">
                    <button onclick="renamePasskey(${passkey.id})" style="background: transparent; border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; color: var(--text-dark);">Rename</button>
                    <button onclick="deletePasskey(${passkey.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">Remove</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load passkeys:', error);
        document.getElementById('passkeysList').innerHTML = '<p style="color: #dc3545; font-size: 13px;">Failed to load passkeys</p>';
    }
}

function base64urlToUint8Array(base64url) {
    const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const binaryString = atob(base64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes;
}

function uint8ArrayToBase64url(uint8Array) {
    const binaryString = String.fromCharCode(...uint8Array);
    const base64 = btoa(binaryString);
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

document.getElementById('showAddPasskeyBtn')?.addEventListener('click', () => {
    document.getElementById('addPasskeyForm').style.display = 'block';
    document.getElementById('passkeyNickname').value = '';
    document.getElementById('passkeyNickname').focus();
});

document.getElementById('cancelAddPasskeyBtn')?.addEventListener('click', () => {
    document.getElementById('addPasskeyForm').style.display = 'none';
});

document.getElementById('addPasskeyBtn')?.addEventListener('click', async () => {
    const nickname = document.getElementById('passkeyNickname').value.trim();
    if (!nickname) {
        alert('Please enter a nickname for this passkey');
        return;
    }

    try {
        const optionsRes = await fetch('/api/auth/webauthn/register/options', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!optionsRes.ok) {
            const error = await optionsRes.json();
            alert('Failed to get registration options: ' + (error.error || 'Unknown error'));
            return;
        }

        const { sessionId, options } = await optionsRes.json();
        const parsedOptions = JSON.parse(options);

        const publicKey = {
            ...parsedOptions,
            challenge: base64urlToUint8Array(parsedOptions.challenge),
            user: {
                ...parsedOptions.user,
                id: base64urlToUint8Array(parsedOptions.user.id)
            }
        };

        const credential = await navigator.credentials.create({ publicKey });

        const credentialJSON = {
            id: credential.id,
            rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
            type: credential.type,
            response: {
                attestationObject: uint8ArrayToBase64url(new Uint8Array(credential.response.attestationObject)),
                clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                transports: credential.response.getTransports ? credential.response.getTransports() : []
            }
        };

        const verifyRes = await fetch('/api/auth/webauthn/register/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId, credential: credentialJSON, nickname })
        });

        const result = await verifyRes.json();
        if (result.success) {
            alert('Passkey added successfully!');
            document.getElementById('addPasskeyForm').style.display = 'none';
            loadPasskeys();
        } else {
            alert('Failed to add passkey: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to create passkey: ' + error.message + '. Make sure your device supports passkeys.');
    }
});

async function renamePasskey(passkeyId) {
    const nickname = prompt('Enter new name:');
    if (!nickname) return;
    try {
        const response = await fetch(`/api/auth/passkeys/${passkeyId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nickname })
        });
        const result = await response.json();
        if (result.success) loadPasskeys();
        else alert(result.error || 'Failed to rename');
    } catch (error) { alert('Network error'); }
}

async function deletePasskey(passkeyId) {
    if (!confirm('Are you sure you want to remove this passkey?')) return;
    try {
        const response = await fetch(`/api/auth/passkeys/${passkeyId}`, { method: 'DELETE' });
        const result = await response.json();
        if (result.success) loadPasskeys();
        else alert(result.error || 'Failed to delete');
    } catch (error) { alert('Network error'); }
}

if (document.getElementById('passkeysList')) {
    loadPasskeys();
}

// WebAuthn Configuration
async function loadWebAuthnConfig() {
    try {
        const response = await fetch('/api/account/webauthn/config');
        const data = await response.json();
        document.getElementById('webauthnRpId').value = data.rp_id || '';
        document.getElementById('webauthnOrigin').value = data.origin || '';
    } catch (error) {
        console.error('Failed to load WebAuthn config:', error);
    }
}

async function testWebAuthnConfig() {
    const rpId = document.getElementById('webauthnRpId').value;
    const origin = document.getElementById('webauthnOrigin').value;
    const messageDiv = document.getElementById('webauthnConfigMessage');
    try {
        const response = await fetch('/api/account/webauthn/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rp_id: rpId, origin: origin })
        });
        const data = await response.json();
        messageDiv.style.display = 'block';
        if (data.success) {
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = data.message;
        } else {
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = data.error;
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'Network error. Please try again.';
    }
}

document.getElementById('webauthnConfigForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const rpId = document.getElementById('webauthnRpId').value;
    const origin = document.getElementById('webauthnOrigin').value;
    const messageDiv = document.getElementById('webauthnConfigMessage');
    try {
        const response = await fetch('/api/account/webauthn/update-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rp_id: rpId, origin: origin })
        });
        const data = await response.json();
        messageDiv.style.display = 'block';
        if (data.success) {
            messageDiv.style.background = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = data.message;
        } else {
            messageDiv.style.background = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = data.error;
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'Network error. Please try again.';
    }
});

if (document.getElementById('webauthnConfigForm')) {
    loadWebAuthnConfig();
}
</script>
