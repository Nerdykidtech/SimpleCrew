<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Simple. Activity</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FDFDFD">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Simple">
    <link rel="apple-touch-icon" href="https://d31s10tn3clc14.cloudfront.net/imgs/deposits/Review+Logos/simple-logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/navigation.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/modals.css">
    <link rel="stylesheet" href="/static/css/mobile.css">
</head>
<body>

    <div id="group-mgmt-modal" class="modal-overlay" onclick="closeGroupMgmt()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="mgmt-title" style="font-weight:700; color:#333; font-size:14px;">Manage Groups</span>
                <span class="close-btn" onclick="closeGroupMgmt()">√ó</span>
            </div>
            <div class="modal-body" id="mgmt-body">
                </div>
        </div>
    </div>

    <div id="tx-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="modal-title-text" style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Details</span>
                <span class="close-btn" onclick="closeModal(event)">√ó</span>
            </div>
            <div class="modal-body" id="modal-body-content"><div style="text-align:center; padding: 20px;">Loading...</div></div>
        </div>
    </div>

    <div id="move-modal" class="modal-overlay" onclick="closeMoveModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Move Money</span>
                <span class="close-btn" onclick="closeMoveModal(event)">√ó</span>
            </div>
            <div class="modal-body">
                <div id="move-message"></div>
                <div class="form-group"><label class="form-label">From</label><select id="move-from" class="form-select"><option>Loading...</option></select></div>
                <div class="form-group"><label class="form-label">To</label><select id="move-to" class="form-select"><option>Loading...</option></select></div>
                <div class="form-group"><label class="form-label">Amount</label><input type="number" id="move-amount" class="form-input" placeholder="0.00" step="0.01"></div>
                <div class="form-group"><label class="form-label">Note (Optional)</label><input type="text" id="move-note" class="form-input" placeholder="What's this for?"></div>
                <button class="btn-goal-add" onclick="executeTransfer()">Transfer Funds</button>
            </div>
        </div>
    </div>

    <div id="bill-modal" class="modal-overlay" onclick="closeBillModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Add Expense</span>
                <span class="close-btn" onclick="closeBillModal(event)">√ó</span>
            </div>
            <div class="modal-body">
                <div id="bill-message"></div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="bill-name" class="form-input" placeholder="e.g. Netflix">
                </div>
                
                <div class="form-row-2" style="position:relative; z-index:4;">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Amount</label>
                        <input type="number" id="bill-amount" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Frequency</label>
                        <select id="bill-freq" class="form-select">
                            <option value="MONTHLY">Once A Month</option>
                            <option value="WEEKLY">Every Week</option>
                            <option value="BIWEEKLY">Every two weeks</option>
                            <option value="QUARTERLY">Every three Months</option>
                            <option value="SEMI_ANNUALLY">Twice a year</option>
                            <option value="ANNUALLY">Once a year</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="position:relative; z-index:3;">
                    <label class="form-label">Day of Month</label>
                    <select id="bill-day" class="form-select">
                        </select>
                </div>

                <div class="form-group" style="position:relative; z-index:50;">
                    <label class="form-label">Identification (Search Transactions)</label>
                    <input type="text" id="bill-id-search" class="form-input" placeholder="Type to search..." autocomplete="off">
                    <div id="suggestion-box" class="suggestion-box"></div>
                </div>

                <div class="form-row-2" style="position:relative; z-index:1;">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Min Amount</label>
                        <input type="number" id="bill-min" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Max Amount</label>
                        <input type="number" id="bill-max" class="form-input" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="bill-variable" class="checkbox-input">
                        <span class="checkbox-label">Adjust for Variable Bills</span>
                    </label>
                    <div class="form-subtext">If a bill is different than expected, update its reservation amount for the next period</div>
                </div>

                <button class="btn-goal-add" onclick="saveBill()">Create Bill</button>
            </div>
        </div>
    </div>

    <div id="pocket-modal" class="modal-overlay" onclick="closePocketModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Create Pocket</span>
                <span class="close-btn" onclick="closePocketModal(event)">√ó</span>
            </div>
            <div class="modal-body">
                <div id="pocket-message"></div>
                <div class="form-group">
                    <label class="form-label">Pocket Name</label>
                    <input type="text" id="pocket-name" class="form-input" placeholder="e.g. Vacation Fund">
                </div>

                <div class="form-group">
                    <label class="form-label">Initial Funding</label>
                    <input type="number" id="pocket-initial" class="form-input" placeholder="0.00">
                    <div id="pocket-funding-hint" class="form-subtext">Safe-to-Spend: $0.00</div>
                </div>                
                
                <div class="form-group">
                    <label class="form-label">Goal Amount ($)</label>
                    <input type="number" id="pocket-amount" class="form-input" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group (Optional)</label>
                    <select id="pocket-group" class="form-select">
                        <option value="">No Group</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <input type="text" id="pocket-desc" class="form-input" placeholder="What is this for?">
                </div>

                <button class="btn-goal-add" onclick="savePocket()">Create Pocket</button>
            </div>
        </div>
    </div>

    <nav class="top-nav">
        <div class="nav-left">
            <div class="logo"><img src="https://d31s10tn3clc14.cloudfront.net/imgs/deposits/Review+Logos/simple-logo.png" alt="Simple"></div>
            <a onclick="switchTab('activity')" id="nav-activity" class="nav-link active">Activity</a>
            <a onclick="switchTab('expenses')" id="nav-expenses" class="nav-link">Expenses</a>
            <a onclick="switchTab('goals')" id="nav-goals" class="nav-link">Pockets</a>
            <a onclick="switchTab('family')" id="nav-family" class="nav-link">Family</a>
            <a onclick="switchTab('cards')" id="nav-cards" class="nav-link">Cards</a>
            <a onclick="switchTab('credit')" id="nav-credit" class="nav-link">Credit</a>
        </div>

        <div class="mobile-center-header" onclick="toggleMobileStats(event)">
            <div class="mobile-top-label" id="mobile-header-label">Safe-to-Spend¬Æ</div>
            <div class="mobile-top-balance" id="mobile-header-balance">$ --.-- <span class="header-arrow">‚ñº</span></div>
            
            <div id="mobile-sts-dropdown" class="mobile-sts-dropdown">
                <div class="mb-dropdown-row"><span id="mb-math-total">$0.00</span> <span class="mb-math-label">Available</span></div>
                <div class="mb-dropdown-row minus"><span id="mb-math-bills">-$0.00</span> <span class="mb-math-label">Bills</span></div>
                <div class="mb-dropdown-row minus"><span id="mb-math-goals">-$0.00</span> <span class="mb-math-label">Pockets</span></div>
                <div class="mb-dropdown-divider"></div>
                <div class="mb-dropdown-row total"><span id="mb-math-sts">$0.00</span> <span class="mb-math-label">Safe-to-Spend</span></div>
            </div>
        </div>
        <div class="nav-right">
            <div class="user-profile">
                <div class="avatar" id="user-avatar">--</div>
                <span style="font-weight:500;" id="user-name">Loading...</span>
                <span style="font-size: 10px;">‚ñº</span>
            </div>
        </div>
    </nav>

    <div class="mobile-bottom-nav">
        <div onclick="switchTab('activity')" id="mb-nav-activity" class="mobile-nav-link active">
            <svg viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            <span>Activity</span>
        </div>
        <div onclick="switchTab('expenses')" id="mb-nav-expenses" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            <span>Expenses</span>
        </div>
        <div onclick="switchTab('goals')" id="mb-nav-goals" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            <span>Pockets</span>
        </div>
        <div onclick="switchTab('family')" id="mb-nav-family" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21v-2a4 4 0 0 1 4-4h5a4 4 0 0 1 4 4v2"/></svg>
            <span>Family</span>
        </div>
        <div onclick="switchTab('cards')" id="mb-nav-cards" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>
            <span>Cards</span>
        </div>
        <div onclick="switchTab('credit')" id="mb-nav-credit" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
            <span>Credit</span>
        </div>
        
        <div onclick="openIntercom()" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            <span>Help</span>
        </div>
    </div>

    <div class="info-header">
        <div class="balance-container">
            <h1><span id="sts-balance">$ --.--</span><span class="sts-label">Safe-to-Spend¬Æ</span></h1>
            <div class="math-line"><span id="math-total">$0.00</span> <span class="math-gray">available balance</span> - <span id="math-sched">$0.00</span> <span class="math-gray">in Bills</span> - <span id="math-goals">$0.00</span> <span class="math-gray">in Pockets</span></div>
        </div>
        <div class="header-links">
            <button class="btn btn-move" id="btn-move-money" onclick="openMoveModal()">Move Money <span style="font-size:16px; line-height:0;">‚áÖ</span></button>
            <div class="header-link-group"><span class="header-link-label">CDs</span><a href="#" class="header-link-action">Open a CD today!</a></div>
        </div>
    </div>

    <div class="controls-bar" id="controls-bar">
        <div class="search-wrapper" id="search-container"><input type="text" class="search-input" id="search-input-box" placeholder="Search activity..."><button class="btn btn-outline" onclick="triggerSearch()">Search</button></div>
    </div>

    <div class="filters" id="filter-bar">
        <span style="color: #999; font-size: 12px;">Current Filters:</span>
        <div id="active-filters" style="display:flex; gap:10px;"><div class="pill" onclick="removeFilter('date')">Last 6 months <span class="pill-remove">√ó</span></div></div>
        <span class="link-blue" onclick="toggleFilterMenu()">More Filters ‚åµ</span>
        <div id="filter-menu" class="filter-popup">
            <div class="popup-header">
                <span class="popup-title">Filter Transactions</span>
                <span class="close-popup" onclick="toggleFilterMenu()">√ó</span>
            </div>
            <div class="filter-group"><span class="filter-label">Date Range</span><div class="filter-row"><input type="date" id="filter-min-date" class="filter-input"><input type="date" id="filter-max-date" class="filter-input"></div></div>
            <div class="filter-group"><span class="filter-label">Amount Range ($)</span><div class="filter-row"><input type="number" id="filter-min-amt" class="filter-input" placeholder="Min"><input type="number" id="filter-max-amt" class="filter-input" placeholder="Max"></div></div>
            <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
        </div>
    </div>

    <div class="main-grid">
        <div class="main-column">

            <div id="view-activity" class="view-section active">
                <div class="section-header-row"><span class="tab-title">Transactions</span><div class="view-toggles"><span class="active">‚â° List</span></div></div>
                <div id="list-container" class="data-container"><div id="tx-loading" style="text-align:center; padding:20px; color:#999;">Loading transactions...</div><div id="tx-content"></div></div>
            </div>

            <div id="view-expenses" class="view-section">
                <div class="section-header-row"><span class="tab-title">Monthly Expenses</span><div class="exp-summary" id="exp-summary-text"></div></div>
                <div id="exp-hero-container"></div>
                <div id="expenses-list" class="data-container">
                    <div style="text-align:center; padding:20px; color:#999;">Loading expenses...</div>
                </div>
            </div>

            <div id="view-goals" class="view-section">
                <div class="section-header-row">
                    <span class="tab-title">Pockets</span>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-manage-groups" onclick="toggleCreditCardPocketsVisibility()" id="toggle-cc-pockets-btn" style="padding: 8px 12px;">
                            <span id="cc-pockets-toggle-text">üí≥ Show CC</span>
                        </button>
                        <button class="btn-manage-groups" onclick="openGroupMgmt()">
                            <span>Manage Groups</span>
                            <span class="icon-gear">‚öôÔ∏è</span>
                        </button>
                    </div>
                </div>
                <div id="goals-list" class="data-container"><div style="text-align:center; padding:20px; color:#999;">Loading goals...</div></div>
            </div>

            <div id="view-family" class="view-section">
                <div class="section-header-row"><span class="tab-title">Family</span></div>
                <div class="data-container" style="padding: 20px;">
                    <div id="family-content"><div style="text-align:center; padding:20px; color:#999;">Loading family...</div></div>
                </div>
            </div>

            <div id="view-cards" class="view-section">
                <div class="section-header-row"><span class="tab-title">Cards</span></div>
                <div class="data-container">
                    <div id="cards-content"><div style="text-align:center; padding:20px; color:#999;">Loading cards...</div></div>
                </div>
            </div>

            <div id="view-credit" class="view-section">
                <div class="section-header-row"><span class="tab-title">Credit Cards</span></div>
                <div class="data-container" style="padding: 40px 20px;">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <!-- Setup Screen (shown when no API key or not configured) -->
                        <div id="credit-setup-screen">
                            <div style="text-align: center; margin-bottom: 40px;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üí≥</div>
                                <h1 style="font-size: 32px; font-weight: 600; color: var(--text-dark); margin-bottom: 10px;">Set Up Credit Card Tracking</h1>
                                <p style="font-size: 18px; color: var(--text-light); line-height: 1.6;">
                                    Connect your credit card to track transactions and stay in sync with Crew.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 40px; margin-bottom: 40px; color: white;">
                                <h2 style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">How It Works</h2>
                                <div style="line-height: 1.8; font-size: 16px;">
                                    <p style="margin-bottom: 16px;">
                                        When you connect your credit card, Crew automatically creates a <strong>"Credit Card" Pocket</strong> to keep your spending in sync.
                                    </p>
                                    <p style="margin-bottom: 16px;">
                                        Money automatically moves from your <strong>Safe-to-Spend</strong> to your Credit Card Pocket whenever you make a purchase, ensuring you always have enough set aside to pay off your credit card balance.
                                    </p>
                                    <p>
                                        This way, you can enjoy the benefits of credit cards‚Äîbuilding credit history, earning points and cash back‚Äîwithout the worry of overspending.
                                    </p>
                                </div>
                            </div>

                            <!-- Provider Selection -->
                            <div id="provider-selection" style="display: none;">
                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark); text-align: center;">Choose Your Provider</h3>
                                <p style="color: var(--text-light); margin-bottom: 30px; text-align: center;">Select how you'd like to connect your credit card account.</p>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                    <div onclick="selectProvider('lunchflow')" style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 30px; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.borderColor='var(--simple-blue)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                        <div style="font-size: 48px; margin-bottom: 16px;">üç±</div>
                                        <h4 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">LunchFlow</h4>
                                        <p style="font-size: 14px; color: var(--text-light); line-height: 1.5; margin-bottom: 12px;">
                                            API-based connection with daily syncing
                                        </p>
                                        <span style="display: inline-block; background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Recommended</span>
                                    </div>

                                    <div onclick="selectProvider('simplefin')" style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 30px; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.borderColor='var(--simple-blue)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                        <div style="font-size: 48px; margin-bottom: 16px;">üîê</div>
                                        <h4 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">SimpleFin</h4>
                                        <p style="font-size: 14px; color: var(--text-light); line-height: 1.5; margin-bottom: 12px;">
                                            Direct protocol connection via token
                                        </p>
                                        <span style="display: inline-block; background: #f3e5f5; color: #7b1fa2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Open Protocol</span>
                                    </div>
                                </div>
                            </div>

                            <!-- LunchFlow Setup -->
                            <div id="lunchflow-setup" style="display: none;">
                                <div style="margin-bottom: 20px;">
                                    <button onclick="showProviderSelection()" style="background: none; border: none; color: var(--simple-blue); cursor: pointer; font-size: 14px; padding: 8px 0;">
                                        ‚Üê Back to provider selection
                                    </button>
                                </div>

                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">LunchFlow Setup</h3>

                                <!-- API Key Setup Instructions -->
                                <div id="api-key-setup" style="background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 2px dashed #ddd;">
                                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Step 1: Configure LunchFlow API Key</h3>
                                <ol style="line-height: 2; color: var(--text-light); padding-left: 20px;">
                                    <li>Sign up for a <a href="https://lunchflow.app" target="_blank" style="color: var(--simple-blue);">LunchFlow account</a></li>
                                    <li>Create an API destination in your LunchFlow dashboard</li>
                                    <li>Copy your API key from the destination settings</li>
                                    <li>Add it to your <code style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-family: monospace;">docker-compose.yml</code> file:</li>
                                </ol>
                                <div style="background: #2d2d2d; color: #f8f8f2; padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace; font-size: 13px; overflow-x: auto;">
                                    <div>environment:</div>
                                    <div>&nbsp;&nbsp;- BEARER_TOKEN=...</div>
                                    <div>&nbsp;&nbsp;- LUNCHFLOW_API_KEY=<span style="color: #ffd700;">YOUR_API_KEY_HERE</span></div>
                                </div>
                                <p style="color: var(--text-light); margin-top: 16px; font-size: 14px;">
                                    Once you've added your API key, restart the Docker container and refresh this page.
                                </p>
                            </div>

                                <!-- Account Selection (shown when API key is configured) -->
                                <div id="account-selection" style="display: none;">
                                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Step 2: Select Your Credit Card Account</h3>
                                    <p style="color: var(--text-light); margin-bottom: 20px;">
                                        Select which account from your LunchFlow connections should be tracked as your credit card account:
                                    </p>
                                    <div id="accounts-list" style="margin-bottom: 20px;">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--simple-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                                            Loading accounts...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SimpleFin Setup -->
                            <div id="simplefin-setup" style="display: none;">
                                <div style="margin-bottom: 20px;">
                                    <button onclick="showProviderSelection()" style="background: none; border: none; color: var(--simple-blue); cursor: pointer; font-size: 14px; padding: 8px 0;">
                                        ‚Üê Back to provider selection
                                    </button>
                                </div>

                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">SimpleFin Setup</h3>

                                <!-- Invalid Token Warning -->
                                <div id="simplefin-invalid-warning" style="display: none; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                                        <div style="font-size: 24px;">‚ö†Ô∏è</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 8px; color: #e65100;">SimpleFin Token Invalid or Revoked</div>
                                            <p style="color: #e65100; line-height: 1.6; margin-bottom: 12px; font-size: 14px;">
                                                Your SimpleFin access token has been revoked or is no longer valid. This can happen if you deleted the connection from your bank's side or if the token expired.
                                            </p>
                                            <button onclick="disconnectSimpleFin()" style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                                Disconnect SimpleFin
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Token Input -->
                                <div id="simplefin-token-input" style="background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 2px dashed #ddd;">
                                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Step 1: Enter Your SimpleFin Setup Token</h3>
                                    <ol style="line-height: 2; color: var(--text-light); padding-left: 20px; margin-bottom: 20px;">
                                        <li>Get your SimpleFin setup token from your bank or financial institution</li>
                                        <li>The token is a Base64-encoded string (one-time use only)</li>
                                        <li>Paste the token below and click "Connect"</li>
                                    </ol>
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">SimpleFin Setup Token</label>
                                        <input type="text" id="simplefin-token-field" placeholder="Paste your Base64-encoded setup token here" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 13px;">
                                    </div>
                                    <button onclick="claimSimpleFinToken()" style="background: var(--simple-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                        Claim Setup Token
                                    </button>
                                    <p style="color: var(--text-light); margin-top: 16px; font-size: 14px;">
                                        Note: The setup token is one-time use. Once claimed, it cannot be used again. Your access credentials will be securely stored.
                                    </p>
                                </div>

                                <!-- Account Selection (shown after token claimed) -->
                                <div id="simplefin-account-selection" style="display: none;">
                                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Step 2: Select Your Credit Card Account</h3>
                                    <p style="color: var(--text-light); margin-bottom: 20px;">
                                        Select which account from your SimpleFin connection should be tracked as your credit card account:
                                    </p>
                                    <div id="simplefin-accounts-list" style="margin-bottom: 20px;">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--simple-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                                            Loading accounts...
                                        </div>
                                    </div>
                                </div>

                                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px; padding: 20px; margin-top: 30px;">
                                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                                        <div style="font-size: 24px;">‚ÑπÔ∏è</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 8px; color: #1565c0;">About SimpleFin</div>
                                            <p style="color: #1565c0; line-height: 1.6; margin: 0; font-size: 14px;">
                                                SimpleFin is a read-only financial data sharing protocol. Your token contains credentials that allow secure access to your account data without sharing passwords. Learn more at <a href="https://www.simplefin.org/protocol.html" target="_blank" style="color: #1565c0; text-decoration: underline;">simplefin.org</a>.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Balance Sync Confirmation Modal (shown after account selection) -->
                            <div id="balance-sync-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; flex-direction: column;">
                                <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: auto;">
                                    <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Sync Balance?</h3>
                                    <p style="color: var(--text-light); margin-bottom: 24px; line-height: 1.6;">
                                        Would you like to sync the pocket balance to match your credit card's current balance?
                                    </p>
                                    <div id="balance-display" style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 24px; text-align: center;">
                                        <div style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">Current Credit Card Balance</div>
                                        <div id="balance-amount" style="font-size: 32px; font-weight: 700; color: var(--text-dark);">Loading...</div>
                                    </div>
                                    <div style="display: flex; gap: 12px;">
                                        <button onclick="handleBalanceSync(false)" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--text-dark);">Skip</button>
                                        <button onclick="handleBalanceSync(true)" style="flex: 1; padding: 12px; border: none; background: var(--simple-blue); color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">Sync Balance</button>
                                    </div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-top: 40px;">
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 24px;">
                                    <div style="font-size: 32px; margin-bottom: 12px;">üîó</div>
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Connect Your Card</h3>
                                    <p style="font-size: 14px; color: var(--text-light); line-height: 1.5;">
                                        Connect your credit card through LunchFlow. Crew will securely sync your account information.
                                    </p>
                                </div>

                                <div style="background: #f8f9fa; border-radius: 12px; padding: 24px;">
                                    <div style="font-size: 32px; margin-bottom: 12px;">üí∞</div>
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Auto-Sync Pocket</h3>
                                    <p style="font-size: 14px; color: var(--text-light); line-height: 1.5;">
                                        A "Credit Card" Pocket is automatically created to reserve funds from your Safe-to-Spend for credit card payments.
                                    </p>
                                </div>

                                <div style="background: #f8f9fa; border-radius: 12px; padding: 24px;">
                                    <div style="font-size: 32px; margin-bottom: 12px;">‚úÖ</div>
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Stay in Sync</h3>
                                    <p style="font-size: 14px; color: var(--text-light); line-height: 1.5;">
                                        Every purchase automatically moves money to your Credit Card Pocket, keeping you aligned with your actual balance.
                                    </p>
                                </div>
                            </div>

                            <div style="border-top: 1px solid #e0e0e0; padding-top: 30px; margin-top: 40px; text-align: center;">
                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Benefits</h3>
                                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; font-size: 14px; color: var(--text-light);">
                                    <span>‚úì Build credit history</span>
                                    <span>‚úì Earn points & rewards</span>
                                    <span>‚úì Never overspend</span>
                                    <span>‚úì Automatic balance tracking</span>
                                </div>
                            </div>

                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; padding: 20px; margin-top: 40px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #856404;">üí° Note</div>
                                <p style="color: #856404; line-height: 1.6; margin: 0; font-size: 14px;">
                                    Once you have a valid API key configured (optional), this screen will change to show your connected accounts and allow you to select which account to track.
                                </p>
                            </div>
                        </div>

                        <!-- Management Interface (shown when fully configured) -->
                        <div id="credit-management-screen" style="display: none;">
                            <!-- Invalid Token Warning (for SimpleFin) -->
                            <div id="credit-management-invalid-warning" style="display: none; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: flex-start; gap: 12px;">
                                    <div style="font-size: 24px;">‚ö†Ô∏è</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 8px; color: #e65100;">SimpleFin Token Invalid or Revoked</div>
                                        <p style="color: #e65100; line-height: 1.6; margin-bottom: 12px; font-size: 14px;">
                                            Your SimpleFin access token has been revoked or is no longer valid. Transactions will not sync until you reconnect.
                                        </p>
                                        <button onclick="disconnectSimpleFin()" style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s; margin-right: 10px;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                            Disconnect SimpleFin
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Last Updated Timestamp -->
                            <div id="credit-last-updated" style="text-align: center; color: var(--text-light); font-size: 13px; margin-bottom: 20px; display: none;">
                                <!-- Will be populated with last sync time -->
                            </div>

                            <!-- Multi-Account Cards Container -->
                            <div id="credit-accounts-list" style="display: grid; gap: 20px; margin-bottom: 20px;">
                                <!-- Account cards will be dynamically inserted here -->
                            </div>

                            <!-- Add Another Account Button -->
                            <button onclick="addAnotherSimpleFinAccount()" style="background: white; border: 2px dashed #ccc; border-radius: 12px; padding: 20px; cursor: pointer; width: 100%; text-align: center; color: var(--simple-blue); font-weight: 600; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--simple-blue)'; this.style.background='#f8f9fa'" onmouseout="this.style.borderColor='#ccc'; this.style.background='white'">
                                + Add Another SimpleFin Card
                            </button>

                            <!-- Sync Schedule Info -->
                            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px; padding: 20px; margin-top: 30px;">
                                <div style="display: flex; align-items: flex-start; gap: 12px;">
                                    <div style="font-size: 24px;">‚ÑπÔ∏è</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 8px; color: #1565c0;">Sync Schedule</div>
                                        <p style="color: #1565c0; line-height: 1.6; margin: 0; font-size: 14px;">
                                            SimpleFin accounts sync automatically every hour in the background. Each account syncs independently, so you can track multiple cards without delays.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="sidebar-column">
            <div class="sidebar-card">
                <div class="card-title"><span>Trends</span><span style="color:#999; font-weight:400; font-size:12px;">Monthly ‚ñº</span></div>
                <div class="trend-row" style="font-weight: 700; color:#AAA; font-size:10px; text-transform:uppercase; letter-spacing:0.5px;"><span>Overview</span><span>This month</span></div>
                <div class="trend-row"><span>Checking</span><span id="checking-val" style="color:var(--text-dark); font-weight:600;">--</span></div>
                <div class="trend-row"><span>Earned</span><span id="trend-earned" style="color:var(--text-light);">$0.00</span></div>
                <div class="trend-row"><span>Spent</span><span id="trend-spent" style="color:var(--text-light);">$0.00</span></div>
            </div>
             <div class="sidebar-card">
                <div class="card-title"><span>Active Pockets</span></div>
                <div id="sidebar-pockets-list">
                    <div style="text-align:center; color:#999; padding:10px;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom App Dialog -->
    <div id="app-dialog-overlay" class="app-dialog-overlay">
        <div class="app-dialog">
            <div class="app-dialog-header">
                <h3 class="app-dialog-title" id="app-dialog-title">Alert</h3>
            </div>
            <div class="app-dialog-body" id="app-dialog-body"></div>
            <div class="app-dialog-footer" id="app-dialog-footer"></div>
        </div>
    </div>

    <!-- Core utilities first -->
    <script src="/static/js/utils/formatters.js"></script>
    <script src="/static/js/utils/helpers.js"></script>
    <script src="/static/js/state.js"></script>

    <!-- API layer -->
    <script src="/static/js/api/cards.js"></script>
    <script src="/static/js/api/goals.js"></script>
    <script src="/static/js/api/expenses.js"></script>
    <script src="/static/js/api/transactions.js"></script>
    <script src="/static/js/api/family.js"></script>
    <script src="/static/js/api/credit.js"></script>

    <!-- UI layer -->
    <script src="/static/js/ui/navigation.js"></script>
    <script src="/static/js/ui/dialogs.js"></script>
    <script src="/static/js/ui/modals.js"></script>
    <script src="/static/js/ui/filters.js"></script>
    <script src="/static/js/ui/rendering.js"></script>

    <!-- Features -->
    <script src="/static/js/features/dragdrop.js"></script>
    <script src="/static/js/features/groups.js"></script>
    <script src="/static/js/features/autorefresh.js"></script>

    <!-- Main app (loaded last) -->
    <script src="/static/js/app.js"></script>
    </body>
</html>